<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Primary Meta Tags -->
    <title>Santa Ressaca | Ultra Premium Drinks & Market</title>
    <meta name="title" content="Santa Ressaca | Ultra Premium Drinks & Market">
    <meta name="description"
        content="Mini mercado Santa Ressaca especializado em bebidas, cervejas e destilados. Entrega r√°pida na sua regi√£o.">
    <meta name="keywords" content="bebidas, mini mercado, cerveja gelada, comprar bebida online, mercado perto de mim">

    <!-- FAVICON (Replace path with your icon) -->
    <link rel="icon" type="image/png" href="imagens/logo.jpg">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://santararessaca.com.br/">
    <meta property="og:title" content="Santa Ressaca | Ultra Premium Drinks & Market">
    <meta property="og:description"
        content="Mini mercado Santa Ressaca especializado em bebidas, cervejas e destilados. Entrega r√°pida na sua regi√£o.">
    <meta property="og:image"
        content="https://images.unsplash.com/photo-1514933651103-005eec06c04b?q=80&w=1200&h=630&auto=format&fit=crop">

    <!-- Styles -->
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@300;400;600;800&display=swap"
        rel="stylesheet">
    <style>
        /* CHAT INTERNAL CUSTOMER */
        .chat-container {
            margin-top: 30px;
            border-top: 1px solid #333;
            padding-top: 20px;
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            background: #050505;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            border: 1px solid #222;
        }

        .chat-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .chat-bubble.customer {
            align-self: flex-end;
            background: var(--yellow);
            color: #000;
            border-bottom-right-radius: 2px;
        }

        .chat-bubble.admin {
            align-self: flex-start;
            background: #222;
            color: #fff;
            border-bottom-left-radius: 2px;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input-area input {
            flex: 1;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .cancelled-step .step-icon {
            background: rgba(239, 68, 68, 0.2) !important;
            border-color: #ef4444 !important;
            color: #ef4444 !important;
        }

        .cancelled-step .step-label {
            color: #ef4444 !important;
        }

        /* PREMIUM TOASTS */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 11000;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .toast {
            min-width: 300px;
            background: rgba(10, 10, 10, 0.95);
            border-left: 5px solid var(--yellow);
            color: #fff;
            padding: 18px 25px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            animation: toastSlideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .success-premium {
            border-left-color: #2ecc71;
        }

        .error-premium {
            border-left-color: #e74c3c;
        }

        .warning-premium {
            border-left-color: #f1c40f;
        }

        .toast-icon {
            font-size: 1.4rem;
        }

        .toast-msg {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.2);
            width: 100%;
            animation: toastProgress 4.5s linear forwards;
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(120%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes toastSlideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(120%);
                opacity: 0;
            }
        }

        @keyframes toastProgress {
            from {
                width: 100%;
            }

            to {
                width: 0%;
            }
        }

        .toast-outro {
            animation: toastSlideOut 0.5s forwards !important;
        }

        /* AGGRESSIVE PREMIUM MODAL */
        .aggressive-modal {
            background: #0a0a0a !important;
            border: 2px solid #222 !important;
            box-shadow: 0 0 50px rgba(241, 196, 15, 0.1) !important;
            border-radius: 20px !important;
        }
    </style>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
</head>


<body>
    <!-- TOAST NOTIFICATIONS container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- MODAL LOJA FECHADA (PREMIUM) -->
    <div id="closed-modal" class="modal"
        style="display: none; align-items: center; justify-content: center; z-index: 10001;">
        <div class="modal-content aggressive-modal" style="max-width: 450px; text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">üõë</div>
            <h2 style="font-family: 'Bebas Neue'; font-size: 2.5rem; color: var(--yellow); margin-bottom: 15px;">ESTAMOS
                FECHADOS</h2>
            <p style="color: #aaa; font-size: 1.1rem; margin-bottom: 25px;">No momento n√£o estamos aceitando pedidos.
                Confira nossos hor√°rios de atendimento:</p>

            <div
                style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; border: 1px solid #333; margin-bottom: 30px;">
                <p style="font-weight: 800; color: white; margin-bottom: 5px;">NOSSO HOR√ÅRIO</p>
                <p id="display-operation-hours"
                    style="font-size: 1.3rem; color: var(--yellow); font-weight: 900; text-transform: uppercase;">
                    CONSULTE NOSSAS REDES</p>
                <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 10px;">
                    <p style="font-size: 0.8rem; color: #666;">ENTREGA R√ÅPIDA & QUALIDADE</p>
                </div>
            </div>

            <button class="btn-primary aggressive"
                onclick="document.getElementById('closed-modal').style.display='none'"
                style="width: 100%;">ENTENDI</button>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>

    <!-- LOADER -->
    <div class="loader-wrapper">
        <div class="loader-content">
            <!-- LOGO PLACEHOLDER IN LOADER -->
            <img src="imagens/logo_carregamento.png" alt="Santa Ressaca Logo" class="loader-image-logo">
            <div class="loader-bar-container">
                <div class="loader-bar"></div>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="main-header">
        <div class="container header-content">
            <!-- LOGO PLACEHOLDER IN HEADER -->
            <div class="logo">
                <a href="#"><img src="imagens/logo.jpg" alt="Santa Ressaca" class="header-image-logo"></a>
            </div>
            <nav class="nav-menu">
                <ul>
                    <li><a href="#inicio">In√≠cio</a></li>
                    <li><a href="#combos">Combos</a></li>
                    <li><a href="#bebidas">Bebidas</a></li>
                    <li><a href="#mercado">Conveni√™ncia</a></li>
                    <li><a href="#sobre">Sobre</a></li>
                    <li><a href="#contato">Contato</a></li>
                    <li id="auth-nav-item"><a href="javascript:void(0)" onclick="openAuthModal('login')"
                            class="btn-auth-nav">Minha Conta</a></li>
                    <li id="user-nav-item" style="display: none;"><a href="javascript:void(0)"
                            onclick="openProfileModal()" class="btn-auth-nav"><span class="highlight">Perfil:</span>
                            <span id="user-display-name"></span></a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="site-content">
        <!-- HERO SECTION -->
        <section id="inicio" class="hero">
            <div class="hero-overlay"></div>
            <div class="container hero-content">
                <h2 class="hero-title reveal">AS MELHORES BEBIDAS E MINI MERCADO DA REGI√ÉO</h2>
                <div class="hero-divider reveal"></div>
                <p class="hero-subtitle reveal">PRE√áO JUSTO ‚Ä¢ QUALIDADE GARANTIDA</p>
                <div class="hero-cta reveal">
                    <a href="https://api.whatsapp.com/send?phone=555195469856&text=Ol%C3%A1!%20Vim%20pelo%20site%20e%20gostaria%20de%20fazer%20um%20pedido."
                        target="_blank" class="btn-primary aggressive">Pedir no WhatsApp</a>
                </div>
            </div>
        </section>

        <!-- PAYMENTS INFO SECTION -->
        <section id="pagamentos" class="payments-strip reveal">
            <div class="container">
                <div class="payments-wrapper">
                    <div class="payment-item">
                        <!-- PIX SVG Icon (Green/Teal) -->
                        <div class="payment-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M11.644 19.3444C11.838 19.5384 12.162 19.5384 12.356 19.3444L19.3444 12.356C19.5384 12.162 19.5384 11.838 19.3444 11.644L12.356 4.6556C12.162 4.4616 11.838 4.4616 11.644 4.6556L4.6556 11.644C4.4616 11.838 4.4616 12.162 4.6556 12.356L11.644 19.3444Z"
                                    fill="#32BCAD" />
                                <path
                                    d="M12.551 16.591L16.591 12.551C16.891 12.251 16.891 11.749 16.591 11.449L12.551 7.4089C12.251 7.1089 11.749 7.1089 11.449 7.4089L7.4089 11.449C7.1089 11.749 7.1089 12.251 7.4089 12.551L11.449 16.591C11.749 16.891 12.251 16.891 12.551 16.591Z"
                                    stroke="white" stroke-width="1.2" />
                            </svg>
                        </div>
                        <div class="payment-text">
                            <strong>PIX</strong>
                            <span>Instant√¢neo</span>
                        </div>
                    </div>
                    <div class="payment-item">
                        <div class="payment-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <rect width="22" height="16" x="1" y="4" rx="3" fill="#444" />
                                <rect width="22" height="4" x="1" y="8" fill="#000" />
                                <rect width="4" height="3" x="4" y="14" rx="1" fill="#888" />
                            </svg>
                        </div>
                        <div class="payment-text">
                            <strong>CART√ÉO</strong>
                            <span>Cr√©dito e D√©bito</span>
                        </div>
                    </div>
                    <div class="payment-item">
                        <!-- BITCOIN ICON (Orange) -->
                        <div class="payment-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" fill="#F7931A" />
                                <path
                                    d="M14.5 10.5C14.5 9.4 13.6 8.5 12.5 8.5H9V15.5H12.5C13.6 15.5 14.5 14.6 14.5 13.5V12.7C14.5 12.1 14.1 11.6 13.6 11.4C14.1 11.2 14.5 10.8 14.5 10.2V10.5ZM10.5 10H12.5C12.8 10 13 10.2 13 10.5C13 10.8 12.8 11 12.5 11H10.5V10ZM10.5 14V13H12.5C12.8 13 13 13.2 13 13.5C13 13.8 12.8 14 12.5 14H10.5Z"
                                    fill="white" />
                                <rect x="10.5" y="7" width="1" height="2" rx="0.5" fill="white" />
                                <rect x="12.5" y="7" width="1" height="2" rx="0.5" fill="white" />
                                <rect x="10.5" y="15" width="1" height="2" rx="0.5" fill="white" />
                                <rect x="12.5" y="15" width="1" height="2" rx="0.5" fill="white" />
                            </svg>
                        </div>
                        <div class="payment-text">
                            <strong>BITCOIN</strong>
                            <span>Cripto Aceito</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- COMBOS SECTION (Simplified) -->
        <section id="combos" class="products category-combos">
            <div class="container">
                <div class="section-badge">Ofertas Exclusivas</div>
                <h2 class="section-title">Nossos <span class="highlight">Combos</span></h2>

                <div class="product-grid" id="grid-combos">
                    <!-- Din√¢mico -->
                </div>
            </div>
        </section>

        <!-- BEBIDAS SECTION -->
        <section id="bebidas" class="products category-drinks">
            <div class="container">
                <div class="section-badge">Bebidas Premium</div>
                <h2 class="section-title">Adega <span class="highlight">Bebidas</span></h2>
                <div class="product-grid" id="grid-bebidas">
                    <!-- Din√¢mico -->
                </div>
            </div>
        </section>



        <!-- CONVENIENCIA / MERCADO SECTION -->
        <section id="mercado" class="products category-market">
            <div class="container">
                <div class="section-badge">Mini Mercado</div>
                <h2 class="section-title">Mercado & <span class="highlight">Conveni√™ncia</span></h2>
                <div class="product-grid" id="grid-conveniencia">
                    <!-- Din√¢mico -->
                </div>
            </div>
        </section>

        <!-- ABOUT SECTION -->
        <section id="sobre" class="about">
            <div class="container about-content">
                <h2 class="section-title">Sobre a <span class="highlight">Santa Ressaca</span></h2>
                <p>Nascemos com a miss√£o de ser o seu <span class="highlight">suporte 24 horas</span> nos momentos de
                    celebra√ß√£o. Seja um churrasco de √∫ltima hora ou aquela resenha com os amigos, a <span
                        class="highlight">Santa Ressaca</span> garante que o estoque nunca acabe.</p>
                <div class="about-stats">
                    <div class="stat-item"><span>+100</span> R√≥tulos</div>
                    <div class="stat-item"><span>100%</span> Gelada</div>
                </div>
            </div>
        </section>

        <!-- CONTACT SECTION -->
        <section id="contato" class="contact">
            <div class="container">
                <div class="contact-header reveal">
                    <h2 class="section-title">Fale <span class="highlight">Conosco</span></h2>
                    <p class="section-subtitle">Estamos prontos para te atender com a melhor conveni√™ncia da regi√£o.</p>
                </div>

                <div class="contact-layout">
                    <div class="contact-cards">
                        <div class="contact-card-premium reveal" style="animation-delay: 0.2s;">
                            <img src="imagens/icone_whats.png" alt="WhatsApp">
                            <h3>WhatsApp</h3>
                            <a href="https://api.whatsapp.com/send?phone=555195469856&text=Ol%C3%A1!%20Gostaria%20de%20fazer%20um%20pedido."
                                target="_blank" class="contact-link">(51) 9546-9856</a>
                            <p>Pe√ßa agora e receba em minutos.</p>
                        </div>

                        <div class="contact-card-premium reveal" style="animation-delay: 0.4s;">
                            <div class="card-icon">üìç</div>
                            <h3>Endere√ßo</h3>
                            <p class="address-text">Rua Silvio Caldas, 10<br>Canoas - RS</p>
                        </div>

                        <div class="contact-card-premium reveal" style="animation-delay: 0.6s;">
                            <div class="card-icon">‚è∞</div>
                            <h3>Hor√°rio</h3>
                            <p>Segunda a S√°bado<br><strong>09:30h √†s 23:00h</strong></p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- MAPS SECTION -->
        <section class="maps-section reveal">
            <div class="container">
                <div class="maps-container aggressive-border">
                    <div class="maps-content">
                        <h2 class="maps-title">Nossa Localiza√ß√£o</h2>
                        <p>Visite nossa loja f√≠sica e confira todas as ofertas!</p>
                        <a href="https://www.google.com/maps/search/?api=1&query=Rua+Silvio+Caldas+10+Canoas+RS"
                            target="_blank" class="btn-primary aggressive maps-btn">
                            <span class="btn-text">VENHA AT√â N√ìS</span>
                        </a>
                    </div>
                    <!-- Empty div for styled feel or static map image background via CSS -->
                    <div class="maps-visual"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- FOOTER -->
    <footer class="main-footer">
        <div class="container footer-content">
            <img src="imagens/logo.jpg" alt="Santa Ressaca" class="footer-logo">
            <p>&copy; 2026 <span class="highlight">Santa Ressaca</span> - Todos os direitos reservados</p>
            <div class="social-links-footer">
                <a href="https://www.instagram.com/canoas_rs_santa_resaca" target="_blank"
                    class="social-link">Instagram</a>
                <a href="https://www.facebook.com/share/1JLBmzV5Yt/?mibextid=wwXIfr" target="_blank"
                    class="social-link">Facebook</a>
            </div>
        </div>
    </footer>

    <!-- WHATSAPP FLOATING BUTTON -->
    <a href="https://api.whatsapp.com/send?phone=555195469856&text=Ol%C3%A1!%20Gostaria%20de%20fazer%20um%20pedido."
        target="_blank" class="whatsapp-float">
        <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
            <path
                d="M16 0C7.163 0 0 7.163 0 16c0 2.825.733 5.48 2.016 7.784L0 32l8.473-2.185A15.93 15.93 0 0 0 16 32c8.837 0 16-7.163 16-16S24.837 0 16 0z"
                fill="#25d366" />
            <path
                d="M16 2.133c-7.653 0-13.867 6.214-13.867 13.867 0 2.7.771 5.216 2.103 7.348l-.208.35L2.83 27.873l4.316-1.112.366.213a13.784 13.784 0 0 0 8.488 2.893c7.653 0 13.867-6.214 13.867-13.867S23.653 2.133 16 2.133zm7.986 19.33c-.33.926-1.637 1.708-2.658 1.815-.705.074-1.625.132-2.73-.243a13.155 13.155 0 0 1-5.74-3.791 14.505 14.505 0 0 1-3.08-4.757c-.64-1.68-.674-3.18-.328-4.148.16-.445.545-.776.92-.95.23-.105.46-.153.687-.153.22 0 .445.048.636.14.436.21.96 1.343 1.05 1.516.088.175.148.376.033.606-.118.232-.178.375-.353.58-.175.204-.37.453-.526.608-.174.175-.356.365-.15.72.204.353.91 1.492 1.956 2.423 1.343 1.196 2.473 1.567 2.825 1.743.353.175.56.148.77-.095.207-.24.896-1.045 1.132-1.403.24-.356.48-.3.805-.178.328.125 2.078 1.026 2.436 1.206.356.178.597.266.684.417.086.15.086.87-.244 1.796z"
                fill="#fff" />
        </svg>
    </a>

    <!-- ORDER MODAL -->
    <div id="orderModal" class="modal">
        <div class="modal-content aggressive-border">
            <span class="close-btn" onclick="closeOrderModal()">&times;</span>
            <h2 class="modal-title">FINALIZAR <span class="highlight">PEDIDO</span></h2>

            <div id="orderSummary" class="order-summary">
                <p id="modalProductName">Combo Sextou</p>
                <p id="modalProductPrice">R$ 220,00</p>
            </div>

            <form id="deliveryForm" class="delivery-form">
                <div class="input-group">
                    <label>Seu Bairro (Canoas)</label>
                    <select id="neighborhood" required onchange="updateDeliveryFee()">
                        <option value="" disabled selected>Selecione seu bairro</option>
                        <option value="Centro" data-fee="5 ">Centro - R$ 5,00</option>
                        <option value="Marechal Rondon" data-fee="7">Marechal Rondon - R$ 7,00</option>
                        <option value="Nossa Senhora das Gra√ßas" data-fee="7">Nossa Senhora das Gra√ßas - R$ 7,00
                        </option>
                        <option value="Igara" data-fee="8">Igara - R$ 8,00</option>
                        <option value="Guajuviras" data-fee="10">Guajuviras - R$ 10,00</option>
                        <option value="Mathias Velho" data-fee="8">Mathias Velho - R$ 8,00</option>
                        <option value="F√°tima" data-fee="10">F√°tima - R$ 10,00</option>
                        <option value="Niter√≥i" data-fee="12">Niter√≥i - R$ 12,00</option>
                        <option value="Rio Branco" data-fee="15">Rio Branco - R$ 15,00</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>WhatsApp (com DDD)</label>
                    <input type="tel" id="orderPhone" placeholder="51999999999" required>
                </div>

                <div class="input-group">
                    <label>Endere√ßo Completo</label>
                    <input type="text" id="address" placeholder="Rua e N√∫mero da casa" required>
                </div>

                <div class="input-group">
                    <label>Complemento (Opcional)</label>
                    <input type="text" id="complement" placeholder="Apto, Bloco, etc.">
                </div>

                <div class="delivery-total">
                    <p class="final-price">Total: <span id="modalTotal">R$ 0,00</span></p>
                </div>

                <button type="button" class="btn-primary aggressive w-full" onclick="sendOrderInternal()">Confirmar
                    Pedido</button>
            </form>
        </div>
    </div>

    <!-- CHECKOUT DE PAGAMENTO PR√ìPRIO -->
    <div id="checkoutModal" class="modal">
        <div class="modal-content aggressive-border" style="max-width:500px;">
            <span class="close-btn" onclick="closeCheckoutModal()">&times;</span>
            <h2 class="modal-title">PAGAMENTO <span class="highlight">PEDIDO</span></h2>
            <p id="checkout-order-ref" style="text-align:center;color:#aaa;margin-bottom:20px;font-size:0.9rem;"></p>

            <!-- SELE√á√ÉO DO M√âTODO -->
            <div id="payment-method-selection">
                <p style="text-align:center;color:#aaa;margin-bottom:18px;font-size:0.85rem;">Escolha como deseja pagar:
                </p>
                <div style="display:flex;flex-direction:column;gap:12px;">
                    <button class="checkout-method-btn" onclick="selectPaymentMethod('cash')">
                        <span style="font-size:1.4rem;">üíµ</span>
                        <div>
                            <strong>Dinheiro na Entrega</strong>
                            <p>Pague ao entregador na hora</p>
                        </div>
                    </button>
                    <button class="checkout-method-btn" onclick="selectPaymentMethod('pix')">
                        <span style="font-size:1.4rem;">üì≤</span>
                        <div>
                            <strong>PIX</strong>
                            <p>Pagamento instant√¢neo ‚Äî QR Code gerado na hora</p>
                        </div>
                    </button>
                    <button class="checkout-method-btn" onclick="selectPaymentMethod('card')">
                        <span style="font-size:1.4rem;">üí≥</span>
                        <div>
                            <strong>Cart√£o de Cr√©dito / D√©bito</strong>
                            <p>Aprova√ß√£o imediata e segura</p>
                        </div>
                    </button>
                </div>
            </div>

            <!-- TELA TROCO (Dinheiro) -->
            <div id="change-screen" style="display:none;text-align:center;">
                <h3
                    style="color:var(--yellow);font-family:'Bebas Neue',sans-serif;font-size:1.5rem;margin-bottom:15px;">
                    PRECISA DE TROCO?</h3>
                <p style="color:#aaa;margin-bottom:20px;font-size:0.9rem;">Informe para quanto voc√™ tem nota:</p>
                <div style="display:flex;flex-direction:column;gap:12px;">
                    <button class="checkout-method-btn" onclick="confirmCashPayment(null)">
                        <span>üí∏</span>
                        <div>
                            <strong>N√£o preciso de troco</strong>
                            <p>Tenho valor exato ou vou pagar de outra forma na hora</p>
                        </div>
                    </button>
                    <div style="background:#111;padding:15px;border-radius:12px;border:1px solid #333;">
                        <label
                            style="display:block;color:#888;font-size:0.75rem;margin-bottom:8px;text-transform:uppercase;">
                            Troco para quanto?</label>
                        <div style="display:flex;gap:10px;">
                            <input type="number" id="change-for-amount" placeholder="Ex: 50.00"
                                style="flex:1;background:#000;border:1px solid #444;color:#fff;padding:12px;border-radius:8px;">
                            <button onclick="confirmCashPayment(document.getElementById('change-for-amount').value)"
                                style="background:var(--yellow);color:#000;border:none;padding:0 20px;border-radius:8px;font-weight:900;cursor:pointer;">OK</button>
                        </div>
                    </div>
                </div>
                <button onclick="backToMethodSelection()" class="checkout-back-btn">‚Üê Voltar</button>
            </div>

            <!-- TELA PIX -->
            <div id="pix-screen" style="display:none;text-align:center;">
                <div id="pix-loading" style="padding:30px 0;">
                    <div class="checkout-spinner"></div>
                    <p style="color:#aaa;margin-top:14px;">Gerando seu PIX...</p>
                </div>
                <div id="pix-content" style="display:none;">
                    <div
                        style="background:#fff;border-radius:12px;padding:12px;display:inline-block;margin-bottom:14px;">
                        <img id="pix-qr-img" src="" alt="QR Code PIX" style="width:200px;height:200px;display:block;">
                    </div>
                    <p style="color:#aaa;font-size:0.8rem;margin-bottom:8px;">Ou copie o c√≥digo abaixo:</p>
                    <div style="position:relative;margin-bottom:16px;">
                        <textarea id="pix-code" readonly
                            style="width:100%;background:#111;color:#fff;border:1px solid #333;border-radius:8px;padding:10px;font-size:0.75rem;resize:none;height:70px;font-family:monospace;"></textarea>
                        <button onclick="copyPixCode()"
                            style="margin-top:8px;background:#FFFF33;color:#000;border:none;padding:10px 20px;border-radius:8px;font-weight:900;cursor:pointer;width:100%;">üìã
                            COPIAR C√ìDIGO PIX</button>
                    </div>
                    <div id="pix-status-area"
                        style="display:flex;align-items:center;justify-content:center;gap:10px;background:#0a0a0a;border-radius:8px;padding:12px;">
                        <div class="checkout-spinner" style="width:18px;height:18px;border-width:2px;"></div>
                        <span style="color:#aaa;font-size:0.85rem;">Aguardando pagamento...</span>
                    </div>
                    <p id="pix-timer" style="color:#666;font-size:0.75rem;margin-top:10px;"></p>
                </div>
                <button onclick="backToMethodSelection()" class="checkout-back-btn">‚Üê Voltar</button>
            </div>

            <!-- TELA CART√ÉO -->
            <div id="card-screen" style="display:none;">
                <form id="card-form" class="delivery-form" style="display:flex;flex-direction:column;gap:14px;">
                    <div class="input-group">
                        <label>Nome no Cart√£o</label>
                        <input type="text" id="card-holder-name" placeholder="Nome como no cart√£o"
                            style="text-transform:uppercase;">
                    </div>
                    <div class="input-group">
                        <label>N√∫mero do Cart√£o</label>
                        <input type="text" id="card-number" placeholder="0000 0000 0000 0000" maxlength="19"
                            oninput="formatCardNumber(this)">
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        <div class="input-group">
                            <label>Validade</label>
                            <input type="text" id="card-expiry" placeholder="MM/AA" maxlength="5"
                                oninput="formatExpiry(this)">
                        </div>
                        <div class="input-group">
                            <label>CVV</label>
                            <input type="text" id="card-cvv" placeholder="123" maxlength="4">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>CPF do Titular</label>
                        <input type="text" id="card-cpf" placeholder="000.000.000-00" maxlength="14"
                            oninput="formatCPF(this)">
                    </div>
                    <div class="input-group">
                        <label>E-mail</label>
                        <input type="email" id="card-email" placeholder="seu@email.com">
                    </div>
                    <div id="card-error"
                        style="color:#ef4444;font-size:0.8rem;display:none;background:rgba(239,68,68,0.1);padding:10px;border-radius:8px;">
                    </div>
                    <button type="button" onclick="processCardPayment()" id="card-submit-btn"
                        style="background:#FFFF33;color:#000;border:none;padding:14px;border-radius:8px;font-weight:900;cursor:pointer;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:1px;">
                        üí≥ PAGAR AGORA
                    </button>
                    <div id="card-loading" style="display:none;text-align:center;padding:10px;">
                        <div class="checkout-spinner" style="margin:0 auto;"></div>
                        <p style="color:#aaa;margin-top:10px;font-size:0.85rem;">Processando pagamento...</p>
                    </div>
                </form>
                <button onclick="backToMethodSelection()" class="checkout-back-btn">‚Üê Voltar</button>
            </div>

            <!-- TELA SUCESSO -->
            <div id="payment-success-screen" style="display:none;text-align:center;padding:20px 0;">
                <div style="font-size:4rem;margin-bottom:16px;">‚úÖ</div>
                <h3 style="color:#FFFF33;font-family:'Bebas Neue',sans-serif;font-size:1.8rem;margin-bottom:8px;">
                    PAGAMENTO CONFIRMADO!</h3>
                <p style="color:#aaa;">Seu pedido foi aprovado e estamos preparando tudo! üçª</p>
                <button onclick="closeCheckoutModal()"
                    style="margin-top:20px;background:#FFFF33;color:#000;border:none;padding:12px 28px;border-radius:8px;font-weight:900;cursor:pointer;">VER
                    MEU PEDIDO</button>
            </div>
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div id="profileModal" class="modal">
        <div class="modal-content aggressive-border">
            <span class="close-btn" onclick="closeProfileModal()">&times;</span>
            <div class="profile-content">
                <h2 class="modal-title">MEU <span class="highlight">PERFIL</span></h2>

                <div class="user-info-card">
                    <div class="info-item">
                        <label>Nome Completo</label>
                        <span id="profile-name">Carregando...</span>
                    </div>
                    <div class="info-item">
                        <label>E-mail</label>
                        <span id="profile-email">Carregando...</span>
                    </div>
                </div>

                <div class="order-history-section">
                    <h3 class="order-history-title">üì¶ √öLTIMOS PEDIDOS</h3>
                    <div id="order-list" class="order-list">
                        <p style="color: #666; font-size: 0.9rem;">Voc√™ ainda n√£o fez nenhum pedido pelo site.</p>
                    </div>
                </div>

                <div class="profile-actions">
                    <button class="btn-secondary" onclick="closeProfileModal()">Fechar</button>
                    <button class="btn-secondary btn-logout-alt" onclick="logout()">Sair da Conta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AUTH MODAL -->
    <div id="authModal" class="modal">
        <div class="modal-content aggressive-border">
            <span class="close-btn" onclick="closeAuthModal()">&times;</span>
            <div id="login-form-container">
                <h2 class="modal-title">LOGIN <span class="highlight">SANTA RESSACA</span></h2>
                <form id="loginForm" class="delivery-form">
                    <div class="input-group">
                        <label>E-mail</label>
                        <input type="email" id="loginEmail" placeholder="seu@email.com" required>
                    </div>
                    <div class="input-group">
                        <label>Senha</label>
                        <input type="password" id="loginPassword" placeholder="******" required>
                    </div>
                    <button type="submit" class="btn-primary aggressive w-full">Entrar</button>
                    <p class="auth-switch">N√£o tem conta? <a href="javascript:void(0)"
                            onclick="openAuthModal('register')">Cadastre-se</a></p>
                </form>
            </div>

            <div id="register-form-container" style="display: none;">
                <h2 class="modal-title">CRIAR <span class="highlight">CONTA</span></h2>
                <form id="registerForm" class="delivery-form">
                    <div class="input-group">
                        <label>Nome Completo</label>
                        <input type="text" id="registerName" required placeholder="Ex: Jo√£o Silva">
                    </div>
                    <div class="input-group">
                        <label>E-mail</label>
                        <input type="email" id="registerEmail" required placeholder="seu@email.com">
                    </div>
                    <div class="input-group">
                        <label>WhatsApp (com DDD)</label>
                        <input type="tel" id="registerPhone" required placeholder="51999999999">
                    </div>
                    <div class="input-group">
                        <label>Senha</label>
                        <input type="password" id="registerPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button type="submit" class="btn-primary aggressive w-full">CADASTRAR</button>
                </form>
                <p class="auth-switch" style="margin-top: 20px; font-size: 0.9rem;">J√° tem conta? <a
                        href="javascript:void(0)" onclick="openAuthModal('login')"
                        style="color: var(--yellow);">Entrar</a></p>
            </div>
        </div>
    </div>

    <!-- STATUS TRACKING MODAL -->
    <div id="statusModal" class="modal">
        <div class="modal-content aggressive-border">
            <span class="close-btn" onclick="closeStatusModal()">&times;</span>
            <div class="status-tracking-content">
                <h2 class="modal-title">ACOMPANHAR <span class="highlight">PEDIDO</span></h2>
                <div class="order-id-badge">Pedido #<span id="track-order-id">---</span></div>
                <div class="status-stepper">
                    <div class="step" id="step-pendente">
                        <div class="step-icon">‚è≥</div>
                        <div class="step-label">Pendente</div>
                    </div>
                    <div class="step" id="step-em_preparo">
                        <div class="step-icon">üë®‚Äçüç≥</div>
                        <div class="step-label">Em Preparo</div>
                    </div>
                    <div class="step" id="step-saiu_entrega">
                        <div class="step-icon">üõµ</div>
                        <div class="step-label">A Caminho</div>
                    </div>
                    <div class="step" id="step-entregue">
                        <div class="step-icon">‚úÖ</div>
                        <div class="step-label">Entregue</div>
                    </div>
                </div>

                <div class="order-summary-box">
                    <div id="track-items-list" class="track-items"></div>
                    <div class="track-total">Total: <span id="track-total-value"></span></div>
                </div>

                <div id="payment-resume-area"
                    style="display:none;margin-top:20px;text-align:center;background:rgba(255,255,51,0.05);padding:20px;border-radius:12px;border:1px dashed var(--yellow);">
                    <p style="color:#fff;font-weight:bold;margin-bottom:10px;">PAGAMENTO PENDENTE</p>
                    <div id="payment-timer"
                        style="font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--yellow);margin-bottom:15px;">
                        05:00</div>
                    <button onclick="resumeOrderPayment()"
                        style="background:var(--yellow);color:#000;border:none;padding:12px 25px;border-radius:8px;font-weight:900;cursor:pointer;width:100%;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;">üí∞
                        FINALIZAR PAGAMENTO AGORA</button>
                </div>

                <p class="status-tip">N√£o feche esta p√°gina para acompanhar em tempo real!</p>
            </div>
        </div>
    </div>

    <script>
        // GLOBAL STATE
        let currentUser = null;
        let isStoreOpen = true;
        let operationHours = '';
        let activeOrderId = null;
        const socket = io();

        // Socket Events
        socket.on('pedido_atualizado', (order) => {
            if (activeOrderId && order.id === activeOrderId) {
                updateStatusUI(order.status);

                // Se cancelado, fecha o timer e avisa
                if (order.status === 'cancelado') {
                    if (trackTimerInterval) clearInterval(trackTimerInterval);
                    document.getElementById('payment-resume-area').style.display = 'none';
                    showToast(`Pedido #${order.id} foi cancelado por tempo expirado.`, 'error');
                }

                // Atualiza visibilidade do c√≥digo
                const codeBadge = document.getElementById('delivery-code-badge');
                if (order.status === 'saiu_entrega' && order.delivery_code) {
                    codeBadge.style.display = 'block';
                    document.getElementById('track-delivery-code').innerText = order.delivery_code;
                } else {
                    codeBadge.style.display = 'none';
                }

                showToast(`Status do pedido #${order.id} atualizado: ${order.status.replace('_', ' ')}! üîî`);
            }
        });

        function updateStatusUI(status) {
            const steps = ['pendente', 'em_preparo', 'saiu_entrega', 'entregue'];
            steps.forEach(s => {
                const el = document.getElementById(`step-${s}`);
                if (el) el.classList.remove('active', 'completed', 'cancelled-step');
            });

            if (status === 'cancelado') {
                const pendente = document.getElementById('step-pendente');
                if (pendente) {
                    pendente.classList.add('cancelled-step');
                    pendente.querySelector('.step-icon').innerText = '‚ùå';
                    pendente.querySelector('.step-label').innerText = 'Cancelado';
                }
                return;
            }

            // Restaura √≠cone original se n√£o estiver cancelado
            const pendenteIcon = document.querySelector('#step-pendente .step-icon');
            const pendenteLabel = document.querySelector('#step-pendente .step-label');
            if (pendenteIcon) pendenteIcon.innerText = '‚è≥';
            if (pendenteLabel) pendenteLabel.innerText = 'Pendente';

            const currentIndex = steps.indexOf(status);
            for (let i = 0; i < currentIndex; i++) {
                document.getElementById(`step-${steps[i]}`).classList.add('completed');
            }
            if (currentIndex !== -1) {
                document.getElementById(`step-${status}`).classList.add('active');
            }
        }

        // PREMIUM TOAST SYSTEM
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            // Estilo Premium
            const icons = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };

            toast.className = `toast ${type}-premium`;
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || 'üîî'}</div>
                <div class="toast-content">
                    <div class="toast-msg">${message}</div>
                </div>
                <div class="toast-progress"></div>
            `;

            container.appendChild(toast);

            // Auto remove
            setTimeout(() => {
                toast.classList.add('toast-outro');
                toast.addEventListener('animationend', () => toast.remove());
            }, 4500);
        }

        // AUTH SYSTEM
        async function checkAuth() {
            try {
                const response = await fetch('/api/me');
                const data = await response.json();
                const btnAdmin = document.getElementById('admin-nav-item'); // Assuming this exists
                const btnProfile = document.getElementById('user-nav-item');
                const btnLogin = document.getElementById('auth-nav-item');

                if (data.loggedIn) {
                    currentUser = data.user;
                    btnLogin.style.display = 'none';
                    btnProfile.style.display = 'block';
                    document.getElementById('user-display-name').innerText = data.user.name.split(' ')[0];
                    if (data.user.is_admin) btnAdmin.style.display = 'block';

                    // Auto-preenche o telefone no modal de pedido se estiver logado
                    const orderPhoneInput = document.getElementById('orderPhone');
                    if (orderPhoneInput) orderPhoneInput.value = data.user.phone || '';

                    // Update profile modal
                    document.getElementById('profile-name').innerText = data.user.name;
                    document.getElementById('profile-email').innerText = data.user.email || 'N√£o informado';
                    return true;
                } else {
                    currentUser = null;
                    btnLogin.style.display = 'block';
                    btnProfile.style.display = 'none';
                    if (btnAdmin) btnAdmin.style.display = 'none'; // Hide admin button if not logged in
                    return false;
                }
            } catch (error) {
                console.error('Erro ao verificar autentica√ß√£o:', error);
            }
        }

        async function fetchInitialSettings() {
            try {
                const res = await fetch('/api/admin/settings');
                const settings = await res.json();
                if (settings.operation_hours) {
                    operationHours = settings.operation_hours;
                    document.getElementById('display-operation-hours').innerText = operationHours;
                }
                if (settings.store_status) {
                    updateStoreUI(settings.store_status);
                }
            } catch (e) { console.error('Erro ao buscar settings iniciais:', e); }
        }

        function updateStoreUI(status) {
            isStoreOpen = (status === 'aberta');
            console.log(`[Loja] Status atual: ${status}`);

            // Atualiza todos os bot√µes de compra (mais o label se fechado)
            document.querySelectorAll('.btn-card').forEach(btn => {
                const card = btn.closest('.product-card');
                const isCombo = card && card.querySelector('.combo-items');

                if (!isStoreOpen) {
                    btn.classList.add('disabled-btn');
                    btn.innerText = 'FECHADO';
                    btn.style.opacity = '0.7';
                } else {
                    btn.classList.remove('disabled-btn');
                    btn.innerText = isCombo ? 'Pedir Combo' : 'Pedir Agora';
                    btn.style.opacity = '1';
                }
            });
        }

        socket.on('store_status_changed', (status) => {
            updateStoreUI(status);
            if (status === 'fechada') {
                showToast('A loja acabou de fechar! üõë', 'warning');
                closeOrderModal();
            } else {
                showToast('A loja est√° aberta! üéâ Boas compras.', 'success');
            }
        });

        socket.on('operation_hours_changed', (hours) => {
            operationHours = hours;
            document.getElementById('display-operation-hours').innerText = hours;
            showToast('Hor√°rio de funcionamento atualizado! üïí', 'info');
        });

        function openProfileModal() {
            document.getElementById('profileModal').style.display = 'flex';
            loadOrders(); // Carrega os pedidos do cliente
        }

        let trackTimerInterval = null;

        function openStatusModal(order) {
            activeOrderId = order.id;
            currentOrder = order; // Sincroniza pedido atual para checkout
            document.getElementById('track-order-id').innerText = order.id;
            document.getElementById('track-total-value').innerText = `R$ ${parseFloat(order.total).toFixed(2).replace('.', ',')}`;
            document.getElementById('track-items-list').innerText = order.items;

            updateStatusUI(order.status);
            loadChatMessages(order.id);
            document.getElementById('statusModal').style.display = 'flex';

            // L√≥gica do Timer para pedidos n√£o pagos
            const resumeArea = document.getElementById('payment-resume-area');
            if (order.status === 'aguardando_pagamento') {
                resumeArea.style.display = 'block';
                startTrackTimer(order.created_at);
            } else {
                resumeArea.style.display = 'none';
                if (trackTimerInterval) clearInterval(trackTimerInterval);
            }
        }

        function startTrackTimer(createdAt) {
            if (trackTimerInterval) clearInterval(trackTimerInterval);
            const timerEl = document.getElementById('payment-timer');

            const updateTimer = () => {
                const now = new Date();
                const created = new Date(createdAt);
                const diff = (created.getTime() + 5 * 60 * 1000) - now.getTime();

                if (diff <= 0) {
                    timerEl.innerText = "EXPIRADO";
                    clearInterval(trackTimerInterval);
                    return;
                }

                const mins = Math.floor(diff / 60000);
                const secs = Math.floor((diff % 60000) / 1000);
                timerEl.innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };

            updateTimer();
            trackTimerInterval = setInterval(updateTimer, 1000);
        }

        function resumeOrderPayment() {
            if (!currentOrder) return;
            closeStatusModal();
            openCheckoutModal(currentOrder);
        }

        async function loadChatMessages(orderId) {
            const chatBox = document.getElementById('chat-messages');
            if (!chatBox) return; // Elemento pode n√£o existir neste contexto

            try {
                const res = await fetch(`/api/orders/${orderId}/messages`);
                const messages = await res.json();

                chatBox.innerHTML = messages.length === 0 ?
                    '<p style="color: #555; font-size: 0.75rem; text-align: center;">Inicie uma conversa se precisar de ajuda com seu pedido.</p>' : '';

                messages.forEach(msg => {
                    appendChatBubble(msg.sender_role, msg.message);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (e) { console.error(e); }
        }

        function appendChatBubble(role, text) {
            const chatBox = document.getElementById('chat-messages');
            const welcomeMsg = chatBox.querySelector('p[style*="text-align: center"]');
            if (welcomeMsg) welcomeMsg.remove();

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${role}`;
            bubble.innerText = text;
            chatBox.appendChild(bubble);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg || !activeOrderId) return;

            try {
                const res = await fetch(`/api/orders/${activeOrderId}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sender_role: 'customer', message: msg })
                });
                if (res.ok) {
                    input.value = '';
                }
            } catch (e) { console.error(e); }
        }

        // Listen for socket chat messages
        socket.on('novo_chat_msg', (data) => {
            if (activeOrderId && data.order_id == activeOrderId) {
                appendChatBubble(data.sender_role, data.message);
                if (data.sender_role === 'admin') {
                    showToast('Nova mensagem da loja! üì®');
                }
            }
        });

        function closeStatusModal() {
            document.getElementById('statusModal').style.display = 'none';
            if (trackTimerInterval) clearInterval(trackTimerInterval);
        }

        async function loadOrders() {
            const list = document.getElementById('order-list');
            try {
                const response = await fetch('/api/orders');
                const orders = await response.json();

                if (orders && orders.length > 0) {
                    list.innerHTML = orders.map(order => {
                        const date = new Date(order.created_at).toLocaleDateString('pt-BR');
                        return `
                            <div class="order-item" onclick="openStatusModal(${JSON.stringify(order).replace(/"/g, '&quot;')})">
                                <div>
                                    <div class="order-name">${order.items.split('\n')[0]}</div>
                                    <div class="order-date">${date}</div>
                                </div>
                                <div class="order-price">R$ ${parseFloat(order.total).toFixed(2).replace('.', ',')}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    list.innerHTML = '<p style="color: #666; font-size: 0.9rem;">Voc√™ ainda n√£o fez nenhum pedido pelo site.</p>';
                }
            } catch (err) {
                console.error('Erro ao carregar pedidos', err);
            }
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        function openAuthModal(type) {
            document.getElementById('authModal').style.display = 'flex';
            if (type === 'login') {
                document.getElementById('login-form-container').style.display = 'block';
                document.getElementById('register-form-container').style.display = 'none';
            } else {
                document.getElementById('login-form-container').style.display = 'none';
                document.getElementById('register-form-container').style.display = 'block';
            }
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (response.ok) {
                    closeAuthModal();
                    checkAuth();
                    showToast('Bem-vindo de volta, ' + (data.user.name.split(' ')[0]) + '! ü•É');
                } else {
                    showToast(data.error || 'E-mail ou senha incorretos.', 'error');
                }
            } catch (err) {
                showToast('Erro na conex√£o com o servidor.', 'error');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password, phone })
                });
                const data = await response.json();
                if (response.ok) {
                    closeAuthModal();
                    checkAuth();
                    showToast('Conta criada com sucesso! Aproveite. üöÄ');
                } else {
                    showToast(data.error || 'Erro ao criar conta.', 'error');
                }
            } catch (err) {
                showToast('Erro na conex√£o com o servidor.', 'error');
            }
        });

        async function logout() {
            await fetch('/api/logout', { method: 'GET' });
            checkAuth();
            closeProfileModal();
            showToast('Voc√™ saiu da sua conta. At√© logo!');
        }

        window.addEventListener('scroll', () => {
            const nav = document.querySelector('nav');
            if (window.scrollY > 50) nav.classList.add('scrolled');
            else nav.classList.remove('scrolled');
        });

        // Initialize
        checkAuth();
        fetchInitialSettings();
        fetchProducts();

        // Check for payment result in URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('payment') === 'success') {
            const orderId = urlParams.get('orderId');
            showToast(`Pagamento do pedido #${orderId} aprovado! üçª`, 'success');
            // Remove params from URL
            window.history.replaceState({}, document.title, window.location.pathname);
        } else if (urlParams.get('payment') === 'failure') {
            showToast('Ops! O pagamento n√£o foi conclu√≠do. Tente novamente.', 'error');
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        async function fetchProducts() {
            try {
                const res = await fetch('/api/products');
                const products = await res.json();

                const grids = {
                    'Combos': document.getElementById('grid-combos'),
                    'Bebidas': document.getElementById('grid-bebidas'),
                    'Conveni√™ncia': document.getElementById('grid-conveniencia')
                };

                // Clear grids
                Object.values(grids).forEach(g => { if (g) g.innerHTML = ''; });

                products.forEach(p => {
                    const grid = grids[p.category];
                    if (!grid) return;

                    const card = document.createElement('div');
                    card.className = 'product-card aggressive-card reveal';

                    const descriptionHtml = p.category === 'Combos'
                        ? `<div class="combo-items">${p.description.split('\n').map(l => `<p>${l}</p>`).join('')}</div>`
                        : `<p class="prod-desc">${p.description}</p>`;

                    const btnLabel = p.category === 'Combos' ? 'Pedir Combo' : 'Pedir Agora';

                    card.innerHTML = `
                        <div class="product-image">
                            <img src="${p.image_url || 'https://via.placeholder.com/400'}" alt="${p.name}" loading="lazy">
                        </div>
                        <div class="product-info">
                            <h3>${p.name}</h3>
                            ${descriptionHtml}
                            <div style="margin-top: auto;">
                                <span class="price">R$ ${parseFloat(p.price).toFixed(2).replace('.', ',')}</span>
                                <button class="btn-card" onclick="openOrderModal('${p.name}', ${p.price}, '${p.description.replace(/\n/g, '\\n')}')">
                                    ${btnLabel}
                                </button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            } catch (e) {
                console.error('Erro ao carregar produtos:', e);
            }
        }

        // ORDER SYSTEM
        let currentProduct = {
            name: '',
            price: 0,
            items: ''
        };

        function openOrderModal(name, price, items) {
            currentProduct = { name, price, items }; // Set currentProduct first

            if (!isStoreOpen) {
                document.getElementById('closed-modal').style.display = 'flex';
                return;
            }
            if (!currentUser) {
                showToast('Fa√ßa login para realizar pedidos! ü•É', 'error');
                openAuthModal('login');
                return;
            }

            document.getElementById('modalProductName').innerText = name;
            document.getElementById('modalProductPrice').innerText = `R$ ${price.toFixed(2)}`;
            document.getElementById('modalTotal').innerText = `R$ ${price.toFixed(2)}`;
            // Removido display de taxa
            document.getElementById('neighborhood').value = '';
            document.getElementById('address').value = '';
            document.getElementById('complement').value = '';
            document.getElementById('orderModal').style.display = 'flex';
        }

        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
        }

        function updateDeliveryFee() {
            const select = document.getElementById('neighborhood');
            const fee = parseFloat(select.options[select.selectedIndex].getAttribute('data-fee')) || 0;
            const total = currentProduct.price + fee;

            // S√≥ atualiza o total
            document.getElementById('modalTotal').innerText = `R$ ${total.toFixed(2)}`;
        }

        async function sendOrderInternal() {
            const neighborhood = document.getElementById('neighborhood').value;
            const address = document.getElementById('address').value;
            const complement = document.getElementById('complement').value;
            const select = document.getElementById('neighborhood');
            const fee = parseFloat(select.options[select.selectedIndex].getAttribute('data-fee')) || 0;

            if (!neighborhood || !address) {
                showToast('Por favor, preencha o endere√ßo de entrega.', 'error');
                return;
            }

            const total = currentProduct.price + fee;
            const phone = document.getElementById('orderPhone').value;

            if (!phone) {
                showToast('Por favor, preencha seu WhatsApp.', 'error');
                return;
            }

            // Verifica antecipadamente se o pagamento online est√° configurado
            try {
                const mpStatusRes = await fetch('/api/payments/status');
                const mpStatus = await mpStatusRes.json();
                if (!mpStatus.configured) {
                    showToast('‚ö†Ô∏è Pagamento online indispon√≠vel no momento. Entre em contato pelo WhatsApp para realizar seu pedido.', 'warning');
                    return;
                }
            } catch (e) {
                showToast('N√£o foi poss√≠vel verificar o sistema de pagamento. Tente novamente.', 'error');
                return;
            }

            const orderData = {
                customer_name: currentUser ? currentUser.name : 'Visitante',
                customer_phone: phone,
                items: currentProduct.name + '\n' + currentProduct.items,
                total: total,
                delivery_address: `${address}, ${neighborhood}` + (complement ? ` - ${complement}` : '')
            };

            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                const order = await response.json();

                if (response.ok) {
                    closeOrderModal();
                    openCheckoutModal(order);
                } else {
                    showToast(order.error || 'Erro ao realizar pedido.', 'error');
                }
            } catch (err) {
                showToast('Erro na conex√£o com o servidor.', 'error');
            }
        }

        // --- SISTEMA DE CHECKOUT PR√ìPRIO ---
        let currentOrder = null;
        let pixPollingInterval = null;
        let mp = null;

        // Inicializa Mercado Pago
        async function initMP() {
            try {
                const res = await fetch('/api/payments/status');
                const data = await res.json();
                if (data.publicKey) {
                    mp = new MercadoPago(data.publicKey);
                    console.log('[MP] SDK Inicializado com chave:', data.publicKey);
                }
            } catch (e) { console.error('Erro ao inicializar MP SDK:', e); }
        }
        initMP();

        let isFinalized = false;

        function openCheckoutModal(order) {
            isFinalized = false; // Reset flag
            currentOrder = order;
            document.getElementById('checkout-order-ref').innerText = `Pedido #${order.id} ‚Ä¢ Total: R$ ${parseFloat(order.total).toFixed(2).replace('.', ',')}`;
            document.getElementById('checkoutModal').style.display = 'flex';
            backToMethodSelection();
        }

        function closeCheckoutModal() {
            document.getElementById('checkoutModal').style.display = 'none';
            if (pixPollingInterval) clearInterval(pixPollingInterval);

            if (isFinalized && currentOrder) {
                openStatusModal(currentOrder);
            } else if (currentOrder) {
                showToast('Pagamento n√£o finalizado. Veja em "Meus Pedidos".', 'warning');
            }
        }

        function backToMethodSelection() {
            document.getElementById('payment-method-selection').style.display = 'block';
            document.getElementById('pix-screen').style.display = 'none';
            document.getElementById('card-screen').style.display = 'none';
            document.getElementById('change-screen').style.display = 'none';
            document.getElementById('payment-success-screen').style.display = 'none';
            if (pixPollingInterval) clearInterval(pixPollingInterval);
        }

        function selectPaymentMethod(method) {
            document.getElementById('payment-method-selection').style.display = 'none';
            if (method === 'cash') {
                document.getElementById('change-screen').style.display = 'block';
            } else if (method === 'pix') {
                document.getElementById('pix-screen').style.display = 'block';
                generatePix();
            } else if (method === 'card') {
                document.getElementById('card-screen').style.display = 'block';
                document.getElementById('card-email').value = (currentUser && currentUser.email) ? currentUser.email : '';
            }
        }

        async function confirmCashPayment(changeAmount) {
            try {
                const res = await fetch('/api/payments/cash', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: currentOrder.id,
                        changeAmount: changeAmount
                    })
                });
                if (res.ok) {
                    showSuccessScreen('cash');
                }
            } catch (e) {
                showToast('Erro ao processar pedido.', 'error');
                backToMethodSelection();
            }
        }
        // Alias para compatibilidade caso outro lugar chame
        const processCashPayment = confirmCashPayment;

        async function generatePix() {
            document.getElementById('pix-loading').style.display = 'block';
            document.getElementById('pix-content').style.display = 'none';
            try {
                const res = await fetch('/api/payments/pix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: currentOrder.id,
                        payerEmail: currentUser.email,
                        payerFirstName: currentUser.name.split(' ')[0],
                        payerLastName: currentUser.name.split(' ')[1] || 'Cliente'
                    })
                });
                const data = await res.json();
                if (res.ok && data.qr_code) {
                    document.getElementById('pix-loading').style.display = 'none';
                    document.getElementById('pix-content').style.display = 'block';
                    document.getElementById('pix-qr-img').src = `data:image/png;base64,${data.qr_code_base64}`;
                    document.getElementById('pix-code').value = data.qr_code;
                    startPixPolling(data.payment_id);
                } else {
                    showToast('Erro ao gerar PIX.', 'error');
                    backToMethodSelection();
                }
            } catch (e) {
                showToast('Erro de conex√£o.', 'error');
                backToMethodSelection();
            }
        }

        function copyPixCode() {
            const code = document.getElementById('pix-code');
            code.select();
            document.execCommand('copy');
            showToast('C√≥digo copiado! ‚úÖ');
        }

        function startPixPolling(paymentId) {
            if (pixPollingInterval) clearInterval(pixPollingInterval);
            pixPollingInterval = setInterval(async () => {
                try {
                    const res = await fetch(`/api/payments/check/${paymentId}`);
                    const data = await res.json();
                    if (data.status === 'approved') {
                        clearInterval(pixPollingInterval);
                        showSuccessScreen();
                    }
                } catch (e) { }
            }, 5000);
        }

        function showSuccessScreen(method = 'online') {
            isFinalized = true;
            document.getElementById('pix-screen').style.display = 'none';
            document.getElementById('card-screen').style.display = 'none';
            document.getElementById('change-screen').style.display = 'none';
            document.getElementById('payment-success-screen').style.display = 'block';

            const title = document.querySelector('#payment-success-screen h3');
            const desc = document.querySelector('#payment-success-screen p');

            if (method === 'cash') {
                title.innerText = 'PEDIDO CONFIRMADO!';
                desc.innerText = 'Seu pedido foi registrado e ser√° pago na entrega. J√° estamos preparando tudo! üçª';
            } else {
                title.innerText = 'PAGAMENTO APROVADO!';
                desc.innerText = 'Recebemos seu pagamento e seu pedido j√° est√° em preparo! üçª';
            }

            showToast('Pedido Finalizado! üçª', 'success');
        }

        // Formata√ß√£o Cart√£o
        function formatCardNumber(el) { el.value = el.value.replace(/\D/g, '').match(/.{1,4}/g)?.join(' ') || el.value; }
        function formatExpiry(el) {
            let v = el.value.replace(/\D/g, '');
            if (v.length > 2) v = v.substring(0, 2) + '/' + v.substring(2);
            el.value = v;
        }
        function formatCPF(el) {
            let v = el.value.replace(/\D/g, '');
            if (v.length > 3) v = v.substring(0, 3) + '.' + v.substring(3);
            if (v.length > 7) v = v.substring(0, 7) + '.' + v.substring(7);
            if (v.length > 11) v = v.substring(0, 11) + '-' + v.substring(11);
            el.value = v;
        }

        async function processCardPayment() {
            const btn = document.getElementById('card-submit-btn');
            const errorArea = document.getElementById('card-error');
            const loading = document.getElementById('card-loading');
            errorArea.style.display = 'none';

            const email = document.getElementById('card-email').value;
            const cpf = document.getElementById('card-cpf').value.replace(/\D/g, '');
            const holderName = document.getElementById('card-holder-name').value;
            const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
            const expiry = document.getElementById('card-expiry').value;
            const cvv = document.getElementById('card-cvv').value;

            if (!email || !cpf || !holderName || !cardNumber || !expiry || !cvv) {
                errorArea.innerText = 'Preencha todos os campos corretamente.';
                errorArea.style.display = 'block';
                return;
            }

            const [month, year] = expiry.split('/');
            const fullYear = '20' + year;

            btn.style.display = 'none';
            loading.style.display = 'block';

            try {
                // 1. Detectar Bandeira (Payment Method)
                const bin = cardNumber.substring(0, 6);
                const paymentMethodsRes = await mp.getPaymentMethods({ bin });
                const paymentMethodId = paymentMethodsRes.results[0]?.id;

                if (!paymentMethodId) {
                    throw new Error('N√£o foi poss√≠vel identificar a bandeira do cart√£o.');
                }

                // 2. Criar Token
                const tokenResponse = await mp.createCardToken({
                    cardNumber,
                    cardholderName: holderName,
                    cardExpirationMonth: month,
                    cardExpirationYear: fullYear,
                    securityCode: cvv,
                    identificationType: 'CPF',
                    identificationNumber: cpf
                });

                const token = tokenResponse.id;

                // 3. Enviar para o Backend
                const res = await fetch('/api/payments/card', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: currentOrder.id,
                        token,
                        paymentMethodId,
                        installments: 1,
                        payerEmail: email,
                        payerCpf: cpf,
                        payerFirstName: holderName.split(' ')[0],
                        payerLastName: holderName.split(' ')[1] || 'Titular'
                    })
                });

                const data = await res.json();
                if (res.ok && (data.status === 'approved' || data.status === 'in_process')) {
                    showSuccessScreen();
                } else {
                    errorArea.innerText = data.error || 'Pagamento recusado ou em an√°lise.';
                    errorArea.style.display = 'block';
                    btn.style.display = 'block';
                    loading.style.display = 'none';
                }
            } catch (e) {
                console.error('Erro no checkout:', e);
                errorArea.innerText = e.message || 'Erro ao processar.';
                errorArea.style.display = 'block';
                btn.style.display = 'block';
                loading.style.display = 'none';
            }
        }

        window.onclick = function (event) {
            if (event.target.className === 'modal' && event.target.id !== 'checkoutModal') {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>

</html>