<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Gestor | Santa Ressaca</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@400;500;600;700;800;900&display=swap');

        :root {
            --black: #000000;
            --yellow: #FFFF33;
            --dark-gray: #0d0d0d;
            --light-gray: #1a1a1a;
            --border: #222222;
            --text-main: #ffffff;
            --text-muted: #888888;
            --sidebar-w: 260px;
            --accent: #FFFF33;
            --bg-page: #000000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }

        h1,
        h2,
        h3,
        .logo-area,
        .nav-label,
        .btn-primary,
        .col-title,
        .stat-label {
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }

        body {
            background: var(--bg-page);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-w);
            flex-shrink: 0;
            background: var(--dark-gray);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 32px 20px;
            z-index: 100;
        }

        .logo-area {
            font-size: 2rem;
            margin-bottom: 40px;
            color: #fff;
            text-align: center;
        }

        .logo-area span {
            color: var(--yellow);
        }

        .nav-group {
            margin-bottom: 32px;
        }

        .nav-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 12px;
            padding: 0 12px;
            letter-spacing: 2px;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #fff;
            font-weight: 600;
            font-size: 1rem;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 1px;
        }

        .nav-item:hover {
            background: var(--light-gray);
            color: var(--yellow);
        }

        .nav-item.active {
            background: var(--yellow);
            color: var(--black);
        }

        .stats-box-sidebar {
            margin-top: auto;
            background: var(--light-gray);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .stat-item-sidebar {
            margin-bottom: 12px;
        }

        .stat-item-sidebar:last-child {
            margin-bottom: 0;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .stat-val {
            font-size: 1.5rem;
            font-weight: 900;
            color: #fff;
            display: block;
            font-family: 'Bebas Neue', sans-serif;
        }

        .stat-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 700;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-page);
            min-width: 0;
        }

        .top-bar {
            height: 72px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            background: #000;
        }

        .top-bar h2 {
            font-size: 1.5rem;
            color: #fff;
            font-family: 'Bebas Neue', sans-serif;
        }

        /* DASHBOARD VIEWS */
        .dashboard-view {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            display: none;
        }

        .dashboard-view.active {
            display: block;
        }

        /* KANBAN BOARD */
        #view-pedidos {
            padding: 0;
            overflow: hidden;
            display: none;
            height: 100%;
        }

        #view-pedidos.active {
            display: flex;
            flex-direction: column;
        }

        .kanban-board {
            display: flex;
            gap: 32px;
            padding: 32px 40px;
            overflow-x: auto;
            height: calc(100vh - 180px);
            align-items: flex-start;
        }

        .kanban-column {
            background: #0d0d0d;
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 340px;
            min-width: 340px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }

        .col-header {
            padding: 16px 20px;
            border-bottom: 2px solid var(--yellow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--dark-gray);
            border-radius: 12px 12px 0 0;
            z-index: 10;
        }

        .col-title {
            font-size: 1.1rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .col-count {
            background: var(--yellow);
            color: var(--black);
            padding: 2px 10px;
            border-radius: 20px;
            font-weight: 900;
            font-size: 0.8rem;
        }

        .order-list-admin {
            padding: 12px;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* CARDS */
        .admin-order-card {
            background: var(--black);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            transition: 0.2s;
        }

        .admin-order-card:hover {
            border-color: var(--yellow);
            transform: translateY(-2px);
        }

        .card-top {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .order-id {
            font-size: 1rem;
            color: var(--yellow);
            font-family: 'Bebas Neue', sans-serif;
        }

        .order-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .customer-name {
            font-weight: 800;
            font-size: 1rem;
            color: #fff;
            margin-bottom: 4px;
        }

        .customer-phone {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .payment-badge {
            font-size: 0.6rem;
            font-weight: 800;
            padding: 4px 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: inline-block;
            text-transform: uppercase;
        }

        .payment-pago {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid #10b981;
        }

        .payment-pendente {
            background: rgba(255, 255, 51, 0.1);
            color: var(--yellow);
            border: 1px solid var(--yellow);
        }

        .order-items-box {
            background: var(--dark-gray);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #ccc;
            margin-bottom: 12px;
            white-space: pre-line;
            border: 1px solid var(--border);
        }

        .order-address {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 16px;
            display: flex;
            gap: 8px;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .order-price {
            font-weight: 900;
            font-size: 1.2rem;
            color: #fff;
            font-family: 'Bebas Neue', sans-serif;
        }

        /* BUTTONS */
        .btn-print {
            background: transparent;
            color: #aaa;
            border: 1px solid #444;
            padding: 6px 12px;
            border-radius: 6px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            letter-spacing: 0.05em;
            transition: all 0.18s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-print:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            border-color: #888;
        }

        /* THERMAL PRINT STYLES */
        @media print {
            @page {
                size: 80mm auto;
                margin: 4mm 2mm;
            }

            body * {
                visibility: hidden !important;
            }

            #thermal-receipt,
            #thermal-receipt * {
                visibility: visible !important;
            }

            #thermal-receipt {
                position: fixed !important;
                left: 0;
                top: 0;
                width: 100% !important;
            }
        }

        .btn-move {
            background: var(--yellow);
            color: var(--black);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            font-weight: 900;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-move:hover {
            filter: brightness(1.2);
            scale: 1.05;
        }

        .btn-action-small {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-action-small:hover {
            border-color: #ef4444;
            color: #ef4444;
        }

        /* TABLES */
        .admin-table-container {
            background: var(--dark-gray);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }

        .admin-table th {
            text-align: left;
            padding: 16px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            color: var(--yellow);
            border-bottom: 2px solid var(--border);
        }

        .admin-table td {
            padding: 16px;
            font-size: 0.9rem;
            color: #fff;
            border-bottom: 1px solid var(--border);
        }

        .sortable-ghost {
            opacity: 0.4;
            background: var(--yellow) !important;
        }

        .admin-table tbody tr {
            cursor: move;
        }

        .prod-img-table {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }

        /* MODALS */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--dark-gray);
            border: 1px solid var(--yellow);
            border-radius: 16px;
            padding: 40px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .modal-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            color: #fff;
            text-align: center;
            margin-bottom: 24px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-family: 'Bebas Neue', sans-serif;
            color: var(--yellow);
            font-size: 1.1rem;
            margin-bottom: 6px;
            letter-spacing: 1px;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            background: var(--black) !important;
            border: 1px solid var(--border) !important;
            padding: 12px !important;
            color: #fff !important;
            border-radius: 8px !important;
            outline: none;
        }

        /* Image Preview Styles */
        .preview-container {
            width: 100%;
            height: 180px;
            background: #111;
            border: 1px dashed #333;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: 0.2s;
        }

        .preview-container:hover {
            border-color: var(--yellow);
        }

        .preview-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .preview-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: #555;
            font-size: 0.8rem;
            text-align: center;
        }

        .preview-container.has-image .preview-placeholder {
            display: none;
        }

        .camera-overlay {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: var(--yellow);
            color: #000;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            font-size: 1.2rem;
        }

        /* SEARCH AREA */
        .search-area {
            display: flex;
            align-items: center;
            background: var(--dark-gray);
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 8px;
            gap: 12px;
        }

        .search-area input {
            background: transparent;
            border: none;
            color: #fff;
            outline: none;
            font-size: 0.9rem;
            width: 200px;
        }

        .btn-primary {
            background: var(--yellow);
            color: var(--black);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 900;
            cursor: pointer;
            transition: 0.2s;
            width: 100%;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .close-btn {
            position: absolute;
            top: 16px;
            right: 20px;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .close-btn:hover {
            color: #fff;
        }

        .highlight {
            color: var(--yellow);
        }

        /* FLOATING CHAT - MODERN WHATSAPP STYLE */
        .floating-chat-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 15px;
        }

        .chat-toggle-btn {
            width: 60px;
            height: 60px;
            background: #25d366;
            color: #fff;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
            position: relative;
        }

        .chat-toggle-btn:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: #fff;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #000;
        }

        .chat-panel {
            width: 380px;
            height: 600px;
            background: #0b141a;
            /* WhatsApp Dark Mode BG */
            border: 1px solid #222e35;
            border-radius: 16px;
            display: none;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
            animation: slideInChat 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInChat {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .chat-panel-header {
            background: #202c33;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .chat-panel-header h3 {
            font-size: 1rem;
            color: #e9edef;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0;
            text-transform: none;
        }

        .order-selector {
            padding: 12px 20px;
            background: #111b21;
            border-bottom: 1px solid #222e35;
        }

        .order-selector select {
            width: 100%;
            background: #202c33;
            border: none;
            padding: 10px;
            color: #e9edef;
            border-radius: 8px;
            font-size: 0.85rem;
            outline: none;
        }

        #chat-messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            /* WA wallpaper */
            background-blend-mode: overlay;
            background-color: rgba(11, 20, 26, 0.95);
        }

        .chat-message {
            max-width: 85%;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            word-wrap: break-word;
        }

        .chat-message.customer {
            align-self: flex-start;
            background: #202c33;
            color: #e9edef;
            border-bottom-left-radius: 2px;
        }

        .chat-message.admin {
            align-self: flex-end;
            background: #005c4b;
            /* WA Admin color */
            color: #e9edef;
            border-bottom-right-radius: 2px;
        }

        .chat-input-area {
            background: #202c33;
            padding: 12px 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input-area input {
            flex: 1;
            background: #2a3942;
            border: none;
            padding: 12px 16px;
            color: #e9edef;
            border-radius: 24px;
            font-size: 0.9rem;
            outline: none;
        }

        .btn-send-chat {
            background: #00a884;
            color: #fff;
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-send-chat:hover {
            transform: scale(1.1);
            background: #00c096;
        }

        /* RESPONSIVIDADE MOBILE */
        .mobile-menu-btn {
            display: none;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 998;
            backdrop-filter: blur(4px);
        }

        /* --- RESPONSIVIDADE: Sidebar retr√°til (a partir de 768px) --- */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100%;
                width: 75%;
                max-width: 300px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 1000;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
            }

            .mobile-menu-btn {
                display: block;
            }

            .sidebar-overlay.active {
                display: block;
            }

            .top-bar {
                left: 0;
                padding: 0 15px;
            }
        }

        /* --- RESPONSIVIDADE: Layout de Celular (max 480px) --- */
        @media (max-width: 480px) {
            .dashboard-view {
                padding: 12px;
            }

            /* Cabe√ßalho das views empilhado */
            .view-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 12px !important;
                margin-bottom: 16px !important;
            }

            .view-header>div {
                width: 100%;
            }

            .view-header>div:last-child {
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }

            .search-area {
                width: 100%;
            }

            .search-area input {
                width: 100%;
                min-width: 0;
            }

            .btn-move[onclick*="openProductModal()"] {
                width: 100%;
                text-align: center;
                padding: 12px;
            }

            /* Stats em coluna */
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            /* Esconde colunas menos importantes da tabela de produtos */
            .admin-table-container {
                overflow-x: hidden;
            }

            .admin-table th:nth-child(3),
            .admin-table th:nth-child(4),
            .admin-table th:nth-child(5),
            .admin-table td:nth-child(3),
            .admin-table td:nth-child(4),
            .admin-table td:nth-child(5) {
                display: none;
            }

            .admin-table td,
            .admin-table th {
                padding: 10px 8px;
                font-size: 0.9rem;
            }

            .prod-img-table {
                width: 48px;
                height: 48px;
            }

            /* Kanban empilhado */
            .kanban-board {
                flex-direction: column;
                gap: 12px;
                padding: 12px 8px;
                overflow-x: hidden;
                height: auto;
            }

            .kanban-column {
                min-width: 100%;
                width: 100%;
            }

            /* Modal de produto: rol√°vel e ocupa a tela toda */
            .modal-content {
                width: 96% !important;
                max-width: none !important;
                margin: 8px auto !important;
                padding: 15px !important;
                max-height: 92vh !important;
                overflow-y: auto !important;
            }

            /* Preview de imagem menor */
            .preview-container {
                height: 140px;
            }

            .top-bar .user-area {
                display: none;
            }

            .top-bar h2 {
                font-size: 1.1rem;
            }
        }
    </style>
</head>

<body>
    <div class="floating-chat-container">
        <div class="chat-panel" id="chat-panel">
            <div class="chat-panel-header">
                <h3><span style="color: #25d366;">‚óè</span> Chat com Clientes</h3>
                <button onclick="toggleChat()"
                    style="background:none; border:none; color:#e9edef; cursor:pointer; font-size: 1.2rem;">‚úï</button>
            </div>

            <div class="order-selector">
                <select id="chat-order-select" onchange="loadSelectedOrderChat()">
                    <option value="">Selecione um pedido para conversar...</option>
                </select>
            </div>

            <div id="chat-messages-container">
                <div style="text-align:center; color:#8696a0; margin-top:20px; font-size: 0.85rem;">
                    Selecione um pedido para visualizar o hist√≥rico de mensagens via WhatsApp.
                </div>
            </div>

            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Mensagem..."
                    onkeypress="if(event.key==='Enter') sendChatMessage()">
                <button class="btn-send-chat" onclick="sendChatMessage()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z">
                        </path>
                    </svg>
                </button>
            </div>
        </div>

        <button class="chat-toggle-btn" onclick="toggleChat()">
            <svg viewBox="0 0 24 24" width="30" height="30" fill="white">
                <path
                    d="M19.005 3.175H4.674C3.642 3.175 2.8 4.017 2.8 5.049V19.005L5.617 16.188H19.005C20.037 16.188 20.879 15.346 20.879 14.314V5.049C20.879 4.017 20.037 3.175 19.005 3.175ZM18.067 13.376H5.617V12.438H18.067V13.376ZM18.067 10.56H5.617V9.622H18.067V10.56ZM18.067 7.743H5.617V6.805H18.067V7.743Z">
                </path>
            </svg>
            <div class="chat-badge" id="chat-badge" style="display: none;">0</div>
        </button>
    </div>

    <!-- Overlay para fechar sidebar no mobile -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <aside class="sidebar" id="sidebar">
        <div class="logo-area">
            SANTA <span>RESSACA</span>
        </div>

        <nav class="nav-group">
            <div class="nav-label">OPERA√á√ïES</div>
            <div class="nav-item active" onclick="switchView('pedidos', this)">
                VIS√ÉO GERAL
            </div>
        </nav>

        <nav class="nav-group">
            <div class="nav-label">INVENT√ÅRIO</div>
            <div class="nav-item" onclick="switchView('produtos', this)">
                PRODUTOS
            </div>
        </nav>

        <nav class="nav-group">
            <div class="nav-label">SISTEMA</div>
            <div class="nav-item" onclick="switchView('configuracoes', this)">
                CONFIGURA√á√ïES
            </div>
        </nav>

        <div class="stats-box-sidebar">
            <div class="stat-item-sidebar">
                <span class="stat-label">Faturamento Hoje</span>
                <span class="stat-val" id="today-revenue">R$ 0,00</span>
            </div>
            <div class="stat-item-sidebar">
                <span class="stat-label">Pedidos Hoje</span>
                <span class="stat-val" id="today-count">0</span>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <header class="top-bar">
            <button class="mobile-menu-btn" onclick="toggleSidebar()">
                ‚ò∞
            </button>
            <h2>SANTA <span style="color:var(--accent)">RESSACA</span></h2>
            <div style="display: flex; align-items: center; gap: 24px;">
                <div id="status-badge"
                    style="font-size: 0.8rem; font-weight: 900; color: #10b981; letter-spacing: 0.1em; display: flex; align-items: center; gap: 8px; font-family: 'Bebas Neue', sans-serif;">
                    <span
                        style="width: 10px; height: 10px; background: #10b981; border-radius: 50%; box-shadow: 0 0 12px rgba(16, 185, 129, 0.6); animation: pulse 2s infinite;"></span>
                    SISTEMA ONLINE
                </div>
                <a href="/api/admin/logout" class="btn-move"
                    style="text-decoration: none; display: flex; align-items: center; justify-content: center; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2);">SAIR</a>
            </div>
        </header>

        <style>
            @keyframes pulse {
                0% {
                    transform: scale(1);
                    opacity: 1;
                }

                50% {
                    transform: scale(1.2);
                    opacity: 0.7;
                }

                100% {
                    transform: scale(1);
                    opacity: 1;
                }
            }
        </style>

        <!-- IMPORT MODAL STYLES -->
        <style>
            .import-dropzone {
                border: 2px dashed #333;
                border-radius: 12px;
                padding: 40px 20px;
                text-align: center;
                cursor: pointer;
                transition: 0.3s;
                background: #0a0a0a;
            }

            .import-dropzone:hover,
            .import-dropzone.drag-over {
                border-color: var(--yellow);
                background: rgba(255, 255, 51, 0.03);
            }

            .import-dropzone-inner {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
                pointer-events: none;
            }

            .import-dropzone.drag-over .import-dropzone-inner {
                pointer-events: none;
            }

            .import-spinner {
                width: 50px;
                height: 50px;
                border: 4px solid #333;
                border-top: 4px solid var(--yellow);
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
                margin: 0 auto;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .import-row {
                background: #111;
                border: 1px solid var(--border);
                border-radius: 10px;
                padding: 14px;
                margin-bottom: 10px;
                display: grid;
                grid-template-columns: 1fr 1fr 100px auto;
                gap: 10px;
                align-items: center;
            }

            .import-row input,
            .import-row select {
                background: #000 !important;
                border: 1px solid #333 !important;
                color: #fff !important;
                padding: 8px !important;
                border-radius: 6px !important;
                font-size: 0.8rem;
                outline: none;
            }

            .import-row .import-row-del {
                background: transparent;
                border: 1px solid #333;
                color: #ef4444;
                width: 32px;
                height: 32px;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1rem;
                transition: 0.2s;
            }

            .import-row .import-row-del:hover {
                background: rgba(239, 68, 68, 0.1);
                border-color: #ef4444;
            }

            @media (max-width: 600px) {
                .import-row {
                    grid-template-columns: 1fr;
                }
            }
        </style>

        <div id="toast-container"></div>


        <!-- VIEW: PEDIDOS (KANBAN) -->
        <section id="view-pedidos" class="dashboard-view active">
            <section class="kanban-board">
                <!-- AGUARDANDO PAGAMENTO -->
                <div class="kanban-col">
                    <div class="col-header" style="border-bottom-color: #666;">
                        <span class="col-title">‚è≥ AGUARDANDO PAGTO</span>
                        <span class="col-count" id="count-aguardando_pagamento">0</span>
                    </div>
                    <div id="list-aguardando_pagamento" class="order-list-admin"></div>
                </div>

                <!-- PENDENTE -->
                <div class="kanban-col">
                    <div class="col-header pendente">
                        <span class="col-title">üì• NOVOS PEDIDOS</span>
                        <span class="col-count" id="count-pendente">0</span>
                    </div>
                    <div id="list-pendente" class="order-list-admin"></div>
                </div>

                <!-- EM PREPARO -->
                <div class="kanban-col">
                    <div class="col-header em_preparo">
                        <span class="col-title">üë®‚Äçüç≥ EM PREPARO</span>
                        <span class="col-count" id="count-em_preparo">0</span>
                    </div>
                    <div id="list-em_preparo" class="order-list-admin"></div>
                </div>

                <!-- SAIU ENTREGA -->
                <div class="kanban-col">
                    <div class="col-header saiu_entrega">
                        <span class="col-title">üõµ SAIU ENTREGA</span>
                        <span class="col-count" id="count-saiu_entrega">0</span>
                    </div>
                    <div id="list-saiu_entrega" class="order-list-admin"></div>
                </div>

                <!-- ENTREGUE -->
                <div class="kanban-col">
                    <div class="col-header entregue">
                        <span class="col-title">‚úÖ FINALIZADOS</span>
                        <span class="col-count" id="count-entregue">0</span>
                    </div>
                    <div id="list-entregue" class="order-list-admin"></div>
                </div>
            </section>
        </section>


        <!-- VIEW: PRODUTOS -->
        <section id="view-produtos" class="dashboard-view">
            <div class="view-header"
                style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 40px;">
                <div>
                    <h1>ESTOQUE</h1>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-top: 4px;">Gerencie os itens do seu
                        card√°pio</p>
                </div>
                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                    <div class="search-area">
                        <span>üîç</span>
                        <input type="text" id="product-search" placeholder="Buscar produto..."
                            onkeyup="filterProducts()">
                    </div>
                    <button class="btn-move" onclick="openImportModal()"
                        style="padding: 12px 24px; background: transparent; color: var(--yellow); border: 2px solid var(--yellow);">üì¶
                        IMPORTAR</button>
                    <button class="btn-move" onclick="openProductModal()" style="padding: 12px 24px;">+ ADICIONAR
                        ITEM</button>
                </div>
            </div>

            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;"></th> <!-- Handle -->
                            <th>IMG</th>
                            <th>PRODUTO</th>
                            <th>CATEGORIA</th>
                            <th>PRE√áO</th>
                            <th>STATUS</th>
                            <th style="text-align: right;">A√á√ïES</th>
                        </tr>
                    </thead>
                    <tbody id="products-tbody">
                        <!-- Din√¢mico -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- MODAL: PRODUTO -->
        <div id="productModal" class="modal">
            <div class="modal-content aggressive-border" style="max-width: 500px;">
                <span class="close-btn" onclick="closeProductModal()">&times;</span>
                <h2 id="productModalTitle" class="modal-title">NOVO <span class="highlight">PRODUTO</span></h2>

                <form id="productForm" onsubmit="saveProduct(event)" class="delivery-form">
                    <input type="hidden" id="prod-id">

                    <div class="input-group">
                        <label>Nome do Produto</label>
                        <input type="text" id="prod-name" placeholder="Ex: Combo Sextou" required>
                    </div>

                    <div class="input-group">
                        <label>Categoria</label>
                        <select id="prod-category" required>
                            <option value="Combos">Combos</option>
                            <option value="Bebidas">Bebidas</option>
                            <option value="Conveni√™ncia">Conveni√™ncia</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Descri√ß√£o / Itens (Separar por linha)</label>
                        <textarea id="prod-description" rows="3" placeholder="‚úÖ 1x Black Label\n‚úÖ 2x Red Bull"
                            style="width: 100%; background: #111; color: #fff; border: 1px solid #333; border-radius: 6px; padding: 10px;"></textarea>
                    </div>

                    <div class="input-group">
                        <label>Pre√ßo (R$)</label>
                        <input type="number" id="prod-price" step="0.01" placeholder="0.00" required>
                    </div>

                    <div class="input-group">
                        <label>Imagem do Produto</label>
                        <div class="preview-container" id="prod-preview-container"
                            onclick="document.getElementById('prod-file-input').click()">
                            <img id="prod-preview-img" src="" style="display: none;">
                            <div class="preview-placeholder" id="prod-preview-placeholder">
                                <span style="font-size: 2.5rem;">üì∏</span>
                                <b>CLIQUE PARA ADICIONAR FOTO</b>
                                <span>Suporta c√¢mera do celular ou galeria</span>
                            </div>
                            <div class="camera-overlay">
                                üì∑
                            </div>
                        </div>
                        <input type="file" id="prod-file-input" accept="image/*" style="display: none;"
                            onchange="handleImageSelection(event)">

                        <label style="font-size: 0.8rem; color: #555;">OU COLE A URL ABAIXO</label>
                        <input type="text" id="prod-image" placeholder="imagens/foto.png"
                            oninput="updatePreviewFromUrl()">
                    </div>

                    <div class="input-group">
                        <label>Status</label>
                        <select id="prod-status">
                            <option value="true">Ativo</option>
                            <option value="false">Inativo</option>
                        </select>
                    </div>

                    <button type="submit" class="btn-primary aggressive w-full">SALVAR PRODUTO</button>
                    <button type="button" id="btn-delete-prod" class="btn-secondary w-full"
                        style="margin-top: 10px; display: none; color: #f44336;" onclick="deleteProduct()">EXCLUIR
                        PRODUTO</button>
                </form>
            </div>
        </div>

        <!-- MODAL: IMPORTA√á√ÉO EM MASSA -->
        <div id="importModal" class="modal">
            <div class="modal-content" style="max-width: 720px; max-height: 90vh; overflow-y: auto;">
                <span class="close-btn" onclick="closeImportModal()">&times;</span>
                <h2 class="modal-title">üì¶ IMPORTAR <span class="highlight">PRODUTOS</span></h2>

                <!-- STEP 1: Upload -->
                <div id="import-step-upload">
                    <p style="color: var(--text-muted); font-size: 0.85rem; text-align: center; margin-bottom: 20px;">
                        Envie uma <b style="color: #fff;">imagem</b> (foto de card√°pio/lista) ou um <b
                            style="color: #fff;">arquivo .txt</b> com seus produtos.
                    </p>

                    <div id="import-dropzone" class="import-dropzone">
                        <input type="file" id="import-file-input" accept=".jpg,.jpeg,.png,.webp,.txt"
                            style="display: none;" onchange="handleImportFileSelect(event)">
                        <div class="import-dropzone-inner"
                            onclick="document.getElementById('import-file-input').click()">
                            <span style="font-size: 3rem;">üìÅ</span>
                            <b style="font-size: 1rem; color: #fff;">ARRASTE OU CLIQUE AQUI</b>
                            <span style="font-size: 0.8rem; color: var(--text-muted);">Formatos: JPG, PNG, WEBP, TXT
                                (m√°x. 10MB)</span>
                        </div>
                    </div>

                    <div id="import-file-preview"
                        style="display: none; margin-top: 16px; padding: 16px; background: #111; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span id="import-file-icon" style="font-size: 1.5rem;">üìÑ</span>
                                <div>
                                    <div id="import-file-name"
                                        style="font-weight: 700; color: #fff; font-size: 0.9rem;"></div>
                                    <div id="import-file-size" style="font-size: 0.75rem; color: var(--text-muted);">
                                    </div>
                                </div>
                            </div>
                            <button onclick="clearImportFile()"
                                style="background: transparent; border: 1px solid #333; color: #888; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">‚úï
                                Remover</button>
                        </div>
                    </div>

                    <div
                        style="margin-top: 16px; padding: 12px; background: #111; border-radius: 8px; border: 1px solid var(--border);">
                        <b style="font-size: 0.75rem; color: var(--yellow); letter-spacing: 1px;">üí° FORMATO DO TXT:</b>
                        <pre
                            style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px; white-space: pre-wrap; line-height: 1.6;">Nome: Schin Lat√£o 350ml
Preco: 5.00
Categoria: Bebidas
Descricao: 1x lata gelada
---
Nome: Combo Sextou
Preco: 80.00
Categoria: Combos
Descricao: 6x Heineken + Gelo</pre>
                    </div>

                    <button id="btn-analyze-import" class="btn-primary"
                        style="margin-top: 20px; font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 1px;"
                        onclick="analyzeImportFile()" disabled>üîç ANALISAR ARQUIVO</button>
                </div>

                <!-- STEP 2: Loading -->
                <div id="import-step-loading" style="display: none; text-align: center; padding: 40px 0;">
                    <div class="import-spinner"></div>
                    <p style="color: #fff; font-weight: 700; margin-top: 20px; font-size: 1rem;">Analisando arquivo...
                    </p>
                    <p id="import-loading-detail"
                        style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">Extraindo produtos...</p>
                </div>

                <!-- STEP 3: Preview -->
                <div id="import-step-preview" style="display: none;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <p style="color: var(--text-muted); font-size: 0.85rem;">Encontramos <b id="import-count"
                                style="color: var(--yellow);">0</b> produto(s). Edite antes de confirmar:</p>
                        <button onclick="addImportRow()"
                            style="background: transparent; border: 1px solid var(--yellow); color: var(--yellow); padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 700;">+
                            ADICIONAR</button>
                    </div>

                    <div id="import-products-list" style="max-height: 400px; overflow-y: auto;"></div>

                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button onclick="backToUpload()"
                            style="flex: 1; background: transparent; border: 1px solid #333; color: #888; padding: 14px; border-radius: 8px; cursor: pointer; font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: 1px;">‚Üê
                            VOLTAR</button>
                        <button id="btn-confirm-import" onclick="confirmImport()"
                            style="flex: 2; background: var(--yellow); color: #000; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; font-weight: 900; letter-spacing: 1px;">‚úÖ
                            CONFIRMAR E IMPORTAR</button>
                    </div>
                </div>

                <!-- STEP 4: Success -->
                <div id="import-step-success" style="display: none; text-align: center; padding: 40px 0;">
                    <span style="font-size: 4rem;">üéâ</span>
                    <h3
                        style="color: #fff; margin-top: 16px; font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem;">
                        IMPORTA√á√ÉO CONCLU√çDA!</h3>
                    <p id="import-success-msg" style="color: var(--text-muted); font-size: 0.9rem; margin-top: 8px;">
                    </p>
                    <button onclick="closeImportModal()" class="btn-primary"
                        style="margin-top: 24px; font-family: 'Bebas Neue', sans-serif; font-size: 1rem;">FECHAR</button>
                </div>
            </div>
        </div>


        <!-- VIEW: SETTINGS (CONFIGURACOES) -->
        <section id="view-configuracoes" class="dashboard-view" style="padding: 40px; overflow-y: auto;">
            <div style="max-width: 1200px;">
                <h1
                    style="font-size: 1.5rem; font-weight: 800; margin-bottom: 40px; color: #fff; letter-spacing: -0.03em;">
                    Configura√ß√µes do Sistema</h1>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 32px;">
                    <!-- STORE OPERATIONS -->
                    <div style="background: #18181b; border: 1px solid #27272a; border-radius: 12px; padding: 32px;">
                        <h3
                            style="font-size: 0.75rem; font-weight: 700; color: var(--text-muted); margin-bottom: 24px; text-transform: uppercase; letter-spacing: 0.1em;">
                            Opera√ß√£o</h3>

                        <div style="display: flex; flex-direction: column; gap: 24px;">
                            <div class="input-group">
                                <label>Status da Loja</label>
                                <select id="config-status">
                                    <option value="aberta">ONLINE & ABERTA</option>
                                    <option value="fechada">OFFLINE & FECHADA</option>
                                </select>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="input-group">
                                    <label>Tempo de Entrega</label>
                                    <input type="text" id="config-time" placeholder="30-45 min">
                                </div>
                                <div class="input-group">
                                    <label>Info Fechamento</label>
                                    <input type="text" id="config-closing" placeholder="Em breve">
                                </div>
                            </div>

                            <div class="input-group">
                                <label>Hor√°rio de Funcionamento</label>
                                <input type="text" id="config-hours" placeholder="Seg a S√°b, 18:00 - 03:00">
                            </div>

                            <button class="btn-move" onclick="saveSettings()" style="width: 100%; padding: 14px;">SALVAR
                                ALTERA√á√ïES</button>
                        </div>
                    </div>

                    <!-- WHATSAPP SERVICE -->
                    <div style="background: #18181b; border: 1px solid #27272a; border-radius: 12px; padding: 32px;">
                        <h3
                            style="font-size: 0.75rem; font-weight: 700; color: var(--text-muted); margin-bottom: 24px; text-transform: uppercase; letter-spacing: 0.1em;">
                            Servi√ßo de Mensagens</h3>

                        <div
                            style="background: #09090b; padding: 20px; border-radius: 12px; border: 1px solid #27272a; margin-bottom: 24px; display: flex; align-items: center; justify-content: center; gap: 12px;">
                            <span id="wa-status-dot" class="wa-status-circle disconnected"
                                style="width: 10px; height: 10px;"></span>
                            <span id="wa-status-badge"
                                style="font-weight: 800; font-size: 0.75rem; color: var(--text-muted); letter-spacing: 0.05em; text-transform: uppercase;">Desconectado</span>
                        </div>

                        <p id="wa-instruction"
                            style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 24px; text-align: center; line-height: 1.6;">
                            Inicie o servidor de mensagens para conectar sua conta.</p>

                        <div id="qr-container"
                            style="display: none; background: #fff; padding: 16px; border-radius: 12px; margin: 0 auto 24px; width: fit-content; box-shadow: 0 8px 24px rgba(0,0,0,0.5);">
                            <canvas id="qr-canvas" style="display: block;"></canvas>
                        </div>

                        <div id="wa-actions" style="display: none; flex-direction: column; gap: 12px;">
                            <button class="btn-move" onclick="window.open('https://web.whatsapp.com', '_blank')"
                                style="background: #25d366; color: #000;">ABRIR WHATSAPP WEB</button>
                            <button onclick="logoutWhatsApp()"
                                style="background: transparent; color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.8125rem;">DESCONECTAR
                                CONTA</button>
                        </div>
                    </div>

                </div>
            </div>
        </section>
    </main>

    <audio id="order-sound" src="https://assets.mixkit.co/active_storage/sfx/2857/2857-preview.mp3"
        preload="auto"></audio>
    <audio id="chat-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"
        preload="auto"></audio>

    <script>
        const socket = io();
        const orderSound = document.getElementById('order-sound');
        const chatSound = document.getElementById('chat-sound');

        // Ajuste de volume
        orderSound.volume = 1.0;
        chatSound.volume = 1.0;
        let orders = [];

        async function init() {
            await Promise.all([
                fetchOrders(),
                fetchStats(),
                fetchProducts(),
                fetchSettings()
            ]);
        }

        // Fun√ß√£o para notifica√ß√£o por voz (TTS)
        function notifyVoice(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'pt-BR';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;

                // Tenta encontrar uma voz em portugu√™s
                const voices = window.speechSynthesis.getVoices();
                const brVoice = voices.find(v => v.lang.includes('pt-BR'));
                if (brVoice) utterance.voice = brVoice;

                window.speechSynthesis.speak(utterance);
            }
        }


        function updateStoreStatusUI(status) {
            const badge = document.getElementById('status-badge');
            if (status === 'aberta') {
                badge.innerText = '‚óè Aberta';
                badge.style.color = '#4caf50';
            } else {
                badge.innerText = '‚óè Fechada';
                badge.style.color = '#e74c3c';
            }
        }

        socket.on('store_status_changed', (status) => {
            updateStoreStatusUI(status);
        });

        async function fetchOrders() {
            const res = await fetch('/api/admin/orders');
            orders = await res.json();
            renderBoard();
        }

        async function fetchStats() {
            try {
                const res = await fetch('/api/admin/stats');
                const stats = await res.json();

                document.getElementById('today-revenue').innerText = `R$ ${parseFloat(stats.todayRevenue).toFixed(2).replace('.', ',')}`;
                document.getElementById('today-count').innerText = stats.todayCount;

                // M√™s placeholder view
                document.querySelector('#view-relatorios .stat-val').innerText = `R$ ${parseFloat(stats.todayRevenue * 30).toFixed(2).replace('.', ',')}`; // Mock mensal
            } catch (e) { console.error('Erro stats:', e); }
        }

        async function fetchProducts() {
            try {
                const res = await fetch('/api/admin/products?v=' + Date.now());
                allProducts = await res.json();
                renderProducts(allProducts);
                initSortable();
            } catch (e) { console.error('Erro prods:', e); }
        }

        let sortableInstance = null;
        function initSortable() {
            const el = document.getElementById('products-tbody');
            if (sortableInstance) sortableInstance.destroy();

            sortableInstance = new Sortable(el, {
                animation: 150,
                handle: 'td:first-child',
                ghostClass: 'sortable-ghost',
                onEnd: async function () {
                    const rows = el.querySelectorAll('tr');
                    const orderedIds = Array.from(rows).map(row => parseInt(row.getAttribute('data-id')));

                    // Instant feedback (Optimistic UI)
                    showToast("Ordem atualizada com sucesso!", "success");

                    // Update local allProducts to match the new order
                    const newProducts = [];
                    orderedIds.forEach(id => {
                        const p = allProducts.find(prod => prod.id === id);
                        if (p) newProducts.push(p);
                    });
                    allProducts = newProducts;

                    // Sync with server in background
                    try {
                        const res = await fetch('/api/admin/products/reorder', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ orderedIds })
                        });
                        if (!res.ok) {
                            console.error('Erro ao salvar ordem no servidor');
                            showToast("Erro ao sincronizar ordem", "error");
                        }
                    } catch (e) {
                        console.error('Erro ao reordenar:', e);
                        showToast("Erro de conex√£o ao reordenar", "error");
                    }
                }
            });
        }

        function renderProducts(list) {
            const tbody = document.getElementById('products-tbody');
            tbody.innerHTML = list.map(p => `
                <tr data-id="${p.id}">
                    <td style="cursor: grab; color: #444; font-size: 1.2rem; text-align: center;">‚†ø</td>
                    <td><img src="${p.image_url || 'https://via.placeholder.com/150'}" class="prod-img-table"></td>
                    <td style="font-weight: 700; color: #fff;">${p.name}</td>
                    <td style="color: var(--text-muted); font-size: 0.85rem;">${p.category}</td>
                    <td style="font-weight: 800; color: var(--yellow); font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem;">R$ ${parseFloat(p.price).toFixed(2).replace('.', ',')}</td>
                    <td>
                        <span style="font-size: 0.75rem; color: ${p.is_active ? '#10b981' : '#ef4444'}; font-weight: 800; letter-spacing: 1px;">
                            ${p.is_active ? '‚óè ATIVO' : '‚óè INATIVO'}
                        </span>
                    </td>
                    <td style="text-align: right; white-space: nowrap;">
                        <button class="btn-move" style="font-size: 0.8rem; padding: 6px 12px;" onclick='openProductModal(${JSON.stringify(p).replace(/'/g, "&apos;")})'>‚öôÔ∏è EDITAR</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterProducts() {
            const term = document.getElementById('product-search').value.toLowerCase();
            const filtered = allProducts.filter(p =>
                p.name.toLowerCase().includes(term) ||
                p.category.toLowerCase().includes(term)
            );
            renderProducts(filtered);
            // Re-init sortable after filter if we want to allow reordering filtered list? 
            // Better to disable reordering when filtered as IDs map might be incomplete.
            if (term) {
                if (sortableInstance) sortableInstance.option('disabled', true);
            } else {
                if (sortableInstance) sortableInstance.option('disabled', false);
            }
        }

        let allProducts = []; // Para busca local no edit

        async function openProductModal(prod = null) {
            const modal = document.getElementById('productModal');
            const title = document.getElementById('productModalTitle');
            const btnDel = document.getElementById('btn-delete-prod');

            document.getElementById('productForm').reset();
            document.getElementById('prod-id').value = '';

            if (prod) {
                title.innerHTML = `EDITAR <span class="highlight">PRODUTO</span>`;
                document.getElementById('prod-id').value = prod.id;
                document.getElementById('prod-name').value = prod.name;
                document.getElementById('prod-category').value = prod.category;
                document.getElementById('prod-description').value = prod.description;
                document.getElementById('prod-price').value = prod.price;
                document.getElementById('prod-image').value = prod.image_url;
                document.getElementById('prod-status').value = prod.is_active.toString();

                // Atualizar preview
                if (prod.image_url) {
                    const previewImg = document.getElementById('prod-preview-img');
                    const previewPlaceholder = document.getElementById('prod-preview-placeholder');
                    const previewContainer = document.getElementById('prod-preview-container');

                    previewImg.src = prod.image_url;
                    previewImg.style.display = 'block';
                    previewPlaceholder.style.display = 'none';
                    previewContainer.classList.add('has-image');
                } else {
                    resetImagePreview();
                }

                btnDel.style.display = 'block';
            } else {
                title.innerHTML = `NOVO <span class="highlight">PRODUTO</span>`;
                resetImagePreview();
                btnDel.style.display = 'none';
            }

            modal.style.display = 'flex';
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        async function saveProduct(e) {
            e.preventDefault();
            console.log('[Product] Iniciando salvamento...');

            const id = document.getElementById('prod-id').value;
            const fileInput = document.getElementById('prod-file-input');
            let imageUrl = document.getElementById('prod-image').value;

            // Se houver um arquivo selecionado, faz o upload primeiro
            if (fileInput.files && fileInput.files[0]) {
                showToast("Fazendo upload da imagem...", "warning");
                const formData = new FormData();
                formData.append('image', fileInput.files[0]);

                try {
                    const uploadRes = await fetch('/api/admin/products/upload', {
                        method: 'POST',
                        body: formData
                    });
                    if (uploadRes.ok) {
                        const uploadData = await uploadRes.json();
                        imageUrl = uploadData.imageUrl;
                    } else {
                        const err = await uploadRes.json();
                        showToast("Erro no upload: " + (err.error || "Tente novamente"), "error");
                        return; // Para o salvamento se o upload falhar
                    }
                } catch (err) {
                    showToast("Erro de conex√£o no upload", "error");
                    return;
                }
            }

            const data = {
                name: document.getElementById('prod-name').value,
                category: document.getElementById('prod-category').value,
                description: document.getElementById('prod-description').value,
                price: parseFloat(document.getElementById('prod-price').value),
                image_url: imageUrl,
                is_active: document.getElementById('prod-status').value === 'true'
            };

            console.log('[Product] Dados coletados:', data);

            const url = id ? `/api/admin/products/${id}` : '/api/admin/products';
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    const result = await res.json();
                    console.log('[Product] Sucesso:', result);
                    showToast(id ? "Produto atualizado!" : "Produto adicionado com sucesso!", "success");
                    closeProductModal();
                    fetchProducts();
                } else {
                    const errorData = await res.json().catch(() => ({ error: 'Erro desconhecido no servidor' }));
                    console.error('[Product] Erro na resposta:', res.status, errorData);
                    showToast(`Erro: ${errorData.error || 'N√£o foi poss√≠vel salvar'}`, "error");
                }
            } catch (e) {
                console.error('[Product] Erro na requisi√ß√£o:', e);
                showToast("Erro de conex√£o ao salvar produto", "error");
            }
        }

        // Novas fun√ß√µes para gest√£o de imagens no frontend
        function handleImageSelection(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const previewImg = document.getElementById('prod-preview-img');
                    const previewPlaceholder = document.getElementById('prod-preview-placeholder');
                    const previewContainer = document.getElementById('prod-preview-container');

                    previewImg.src = e.target.result;
                    previewImg.style.display = 'block';
                    previewPlaceholder.style.display = 'none';
                    previewContainer.classList.add('has-image');
                };
                reader.readAsDataURL(file);
            }
        }

        function updatePreviewFromUrl() {
            const url = document.getElementById('prod-image').value;
            const previewImg = document.getElementById('prod-preview-img');
            const previewPlaceholder = document.getElementById('prod-preview-placeholder');
            const previewContainer = document.getElementById('prod-preview-container');

            if (url) {
                previewImg.src = url;
                previewImg.style.display = 'block';
                previewPlaceholder.style.display = 'none';
                previewContainer.classList.add('has-image');
            } else {
                resetImagePreview();
            }
        }

        function resetImagePreview() {
            const previewImg = document.getElementById('prod-preview-img');
            const previewPlaceholder = document.getElementById('prod-preview-placeholder');
            const previewContainer = document.getElementById('prod-preview-container');
            const fileInput = document.getElementById('prod-file-input');

            previewImg.src = '';
            previewImg.style.display = 'none';
            previewPlaceholder.style.display = 'flex';
            previewContainer.classList.remove('has-image');
            fileInput.value = ''; // Limpa o input de arquivo
        }

        async function deleteProduct() {
            const id = document.getElementById('prod-id').value;
            if (!id || !confirm('Tem certeza que deseja excluir este produto?')) return;

            try {
                const res = await fetch(`/api/admin/products/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    closeProductModal();
                    fetchProducts();
                }
            } catch (e) { console.error(e); }
        }

        async function fetchSettings() {
            try {
                const res = await fetch('/api/admin/settings');
                const settings = await res.json();
                if (settings.store_status) {
                    document.getElementById('config-status').value = settings.store_status;
                    updateStoreStatusUI(settings.store_status);
                }
                if (settings.delivery_time) document.getElementById('config-time').value = settings.delivery_time;
                if (settings.operation_hours) document.getElementById('config-hours').value = settings.operation_hours;
            } catch (e) { console.error('Erro settings:', e); }
        }

        async function saveSettings() {
            const status = document.getElementById('config-status').value;
            const time = document.getElementById('config-time').value;
            const hours = document.getElementById('config-hours').value;

            await fetch('/api/admin/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: 'store_status', value: status })
            });
            await fetch('/api/admin/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: 'delivery_time', value: time })
            });
            await fetch('/api/admin/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: 'operation_hours', value: hours })
            });

            showToast("Configura√ß√µes salvas com sucesso!", "success");
        }


        function renderBoard() {
            const statuses = ['aguardando_pagamento', 'pendente', 'em_preparo', 'saiu_entrega', 'entregue'];
            let revenue = 0;
            let count = 0;

            statuses.forEach(status => {
                const list = document.getElementById(`list-${status}`);
                const counter = document.getElementById(`count-${status}`);
                const filtered = orders.filter(o => o.status === status);

                list.innerHTML = '';
                filtered.forEach(order => {
                    list.appendChild(createOrderCard(order));
                    if (status === 'entregue') {
                        revenue += parseFloat(order.total);
                    }
                    if (status !== 'cancelado') count++;
                });

                counter.innerText = filtered.length;
            });

            document.getElementById('today-revenue').innerText = `R$ ${revenue.toFixed(2).replace('.', ',')}`;
            document.getElementById('today-count').innerText = orders.length;
        }

        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'admin-order-card';

            const time = new Date(order.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const methodLabels = { 'pix': 'PIX', 'cartao': 'CART√ÉO', 'dinheiro': 'DINHEIRO', 'online': 'ONLINE' };
            const methodLabel = methodLabels[order.payment_method] || (order.payment_method ? order.payment_method.toUpperCase() : 'PENDENTE');

            let changeHtml = '';
            if (order.payment_method === 'dinheiro' && order.change_amount) {
                changeHtml = `<div style="color:var(--yellow); font-size:0.75rem; margin-top:4px; font-weight:bold;">üíµ TROCO PARA: R$ ${parseFloat(order.change_amount).toFixed(2).replace('.', ',')}</div>`;
            }

            const paymentStatus = (order.payment_status || 'pendente').toLowerCase();
            const paymentClass = paymentStatus === 'pago' ? 'payment-pago' : 'payment-pendente';
            const paymentLabel = paymentStatus === 'pago' ? 'PAGO' : 'PENDENTE';

            // Serializa o pedido para o atributo de dados (para impress√£o)
            const orderDataEncoded = encodeURIComponent(JSON.stringify(order));
            const showPrintBtn = order.status !== 'aguardando_pagamento';

            card.innerHTML = `
                <div class="card-top">
                    <span class="order-id">#${order.id}</span>
                    <span class="order-time">${time}</span>
                </div>
                <div class="customer-name">${order.customer_name}</div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div class="customer-phone">üìû ${order.customer_phone}</div>
                    <div style="position: relative;">
                        <button class="btn-move" style="padding: 4px 8px; font-size: 0.7rem; background: #25d366; color: #000;" 
                            onclick="openIntegratedChat(${order.id})">üí¨ CHAT</button>
                        <div id="chat-indicator-${order.id}" style="display: none; position: absolute; top: -5px; right: -5px; width: 10px; height: 10px; background: #ef4444; border-radius: 50%; border: 1px solid #000;"></div>
                    </div>
                </div>
                <div style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px;">
                    <div class="payment-badge ${paymentClass}">
                        ${paymentLabel}
                    </div>
                    <div class="payment-badge" style="background:rgba(255,255,255,0.05); border:1px solid #444; color:#aaa;">
                        M√âTODO: ${methodLabel}
                    </div>
                </div>
                ${changeHtml}
                <div class="order-items-box">${order.items}</div>
                <div class="order-address">
                    <span>üìç</span>
                    <span>${order.delivery_address || 'Retirada no Local'}</span>
                </div>
                <div class="card-footer">
                    <span class="order-price" style="color: var(--yellow);">R$ ${parseFloat(order.total).toFixed(2).replace('.', ',')}</span>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        ${showPrintBtn ? `<button class="btn-print" onclick="printComanda(decodeURIComponent('${orderDataEncoded}'))">üñ®Ô∏è IMPRIMIR</button>` : ''}
                        ${getMoveButton(order)}
                    </div>
                </div>
            `;
            return card;
        }

        function notifyWhatsApp(orderId, phone, status) {
            // Limpar o telefone (remover caracteres n√£o num√©ricos)
            const cleanPhone = phone.replace(/\D/g, '');
            let message = "";

            const templates = {
                'pendente': `Ol√°! Recebemos seu pedido #${orderId} na * Santa Ressaca * ! ü•É Aguarde um momento enquanto validamos tudo.`,
                'em_preparo': `√ìtimas not√≠cias! Seu pedido #${orderId} j√° est√° sendo preparado pela nossa equipe. üë®‚Äçüç≥üî•`,
                'saiu_entrega': `A Santa Ressaca est√° chegando! üõµüí® Seu pedido #${orderId} acabou de sair para entrega.`,
                'entregue': `Pedido #${orderId} entregue! ‚úÖ Aproveite sua ressurrei√ß√£o e n√£o esque√ßa de nos marcar! ü•Ç‚ú®`,
                'cancelado': `Infelizmente seu pedido #${orderId} foi cancelado. üõë Entre em contato se precisar de ajuda.`
            };

            message = templates[status] || templates['pendente'];
            const url = `https://api.whatsapp.com/send?phone=55${cleanPhone}&text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        function getMoveButton(order) {
            if (order.status === 'aguardando_pagamento')
                return `
                    <button class="btn-move" style="background:#555; color:#fff;" onclick="updateStatus(${order.id}, 'pendente')">FOR√áAR PENDENTE</button>
                    <button class="btn-action-small" onclick="updateStatus(${order.id}, 'cancelado')">‚úï</button>
                `;
            if (order.status === 'pendente')
                return `
                    <button class="btn-move" onclick="updateStatus(${order.id}, 'em_preparo')">PREPARAR</button>
                    <button class="btn-action-small" onclick="updateStatus(${order.id}, 'cancelado')">‚úï</button>
                `;
            if (order.status === 'em_preparo')
                return `
                    <button class="btn-move" onclick="updateStatus(${order.id}, 'saiu_entrega')">ENVIAR</button>
                `;
            if (order.status === 'saiu_entrega')
                return `
                    <button class="btn-move" onclick="updateStatus(${order.id}, 'entregue')">ENTREGAR</button>
                `;
            return '';
        }

        // ============================
        // IMPRESS√ÉO DE COMANDA T√âRMICA
        // ============================
        function printComanda(orderJson) {
            const order = JSON.parse(orderJson);

            const methodLabels = { 'pix': 'PIX', 'cartao': 'CART√ÉO', 'dinheiro': 'DINHEIRO', 'online': 'ONLINE' };
            const methodLabel = methodLabels[order.payment_method] || (order.payment_method ? order.payment_method.toUpperCase() : 'N/D');

            const now = new Date();
            const dateStr = now.toLocaleDateString('pt-BR');
            const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            const orderTime = new Date(order.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            let changeHtml = '';
            if (order.payment_method === 'dinheiro' && order.change_amount) {
                changeHtml = `
                    <tr>
                        <td colspan="3" style="padding: 2px 0; font-weight: bold;">üíµ TROCO PARA: R$ ${parseFloat(order.change_amount).toFixed(2).replace('.', ',')}</td>
                    </tr>`;
            }

            // Formata itens do pedido ‚Äî apenas a primeira linha (t√≠tulo do produto/pedido)
            const itemsRaw = order.items || '';
            const itemLines = itemsRaw
                .split('\n')
                .map(i => i.trim())
                .filter(i => i.length > 0)
                .slice(0, 1) // Pega apenas o t√≠tulo (primeira linha)
                .map(i => `<div style="padding: 2px 0; font-size: 13px; font-weight: bold;">‚Ä¢ ${i}</div>`)
                .join('');

            const receiptHtml = `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <title>Comanda #${order.id} - Santa Ressaca</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body {
                            font-family: 'Courier New', Courier, monospace;
                            font-size: 13px;
                            color: #000;
                            width: 80mm;
                            padding: 4mm 3mm;
                            background: #fff;
                        }
                        .center { text-align: center; }
                        .bold { font-weight: bold; }
                        .separator {
                            border: none;
                            border-top: 1px dashed #000;
                            margin: 6px 0;
                        }
                        .logo {
                            font-size: 20px;
                            font-weight: 900;
                            letter-spacing: 2px;
                            text-transform: uppercase;
                        }
                        .section-label {
                            font-size: 11px;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            margin: 4px 0 2px;
                            font-weight: bold;
                        }
                        .total-row {
                            display: flex;
                            justify-content: space-between;
                            font-weight: bold;
                            font-size: 15px;
                            margin-top: 4px;
                        }
                        .footer-msg {
                            text-align: center;
                            font-size: 11px;
                            margin-top: 8px;
                            line-height: 1.6;
                        }
                        @media print {
                            @page {
                                size: 80mm auto;
                                margin: 2mm;
                            }
                            body { width: 100%; }
                        }
                    </style>
                </head>
                <body>
                    <div class="center">
                        <div class="logo">üéÖ Santa Ressaca</div>
                        <div style="font-size:11px; margin-top:2px;">Bebidas & Mini Mercado</div>
                    </div>

                    <hr class="separator">

                    <div class="bold center" style="font-size:15px;">Nota Pedido #${order.id}</div>
                    <div class="center" style="font-size:11px; margin-top:2px;">${dateStr} √†s ${timeStr} | Pedido: ${orderTime}</div>

                    <hr class="separator">

                    <div class="section-label">üë§ Cliente</div>
                    <div class="bold">${order.customer_name}</div>
                    <div style="font-size:12px;">${order.customer_phone || ''}</div>

                    <hr class="separator">

                    <div class="section-label">üõí Itens do Pedido</div>
                    <div style="margin: 4px 0;">${itemLines}</div>

                    <hr class="separator">

                    <div class="section-label">üìç Endere√ßo de Entrega</div>
                    <div style="font-size:12px; line-height:1.5;">${order.delivery_address || 'Retirada no Local'}</div>

                    <hr class="separator">

                    <div class="section-label">üí≥ Pagamento</div>
                    <div style="font-size:12px;">M√©todo: <strong>${methodLabel}</strong></div>
                    ${order.payment_method === 'dinheiro' && order.change_amount ? `<div style="font-size:12px;">Troco para: <strong>R$ ${parseFloat(order.change_amount).toFixed(2).replace('.', ',')}</strong></div>` : ''}
                    <div class="total-row">
                        <span>TOTAL:</span>
                        <span>R$ ${parseFloat(order.total).toFixed(2).replace('.', ',')}</span>
                    </div>

                    <hr class="separator">

                    <div class="footer-msg">
                        Obrigado pela prefer√™ncia! ü•É<br>
                        <strong>Santa Ressaca</strong><br>
                        "Se beber, n√£o dirija."
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank', 'width=320,height=600,scrollbars=yes');
            if (!printWindow) {
                showToast('Habilite popups para imprimir a comanda.', 'warning');
                return;
            }
            printWindow.document.write(receiptHtml);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 400);
        }

        let pendingDeliveryOrderId = null;
        function openDeliveryModal(orderId) {
            pendingDeliveryOrderId = orderId;
            const select = document.getElementById('delivery-user-select');
            select.innerHTML = '<option value="">Selecione o Entregador</option>' +
                deliveryUsers.map(u => `<option value="${u.id}">${u.name}</option>`).join('');

            document.getElementById('modal-delivery-assignment').style.display = 'flex';
        }

        function closeDeliveryModal() {
            document.getElementById('modal-delivery-assignment').style.display = 'none';
        }

        function confirmAssignment() {
            const deliveryUserId = document.getElementById('delivery-user-select').value;
            if (!deliveryUserId) {
                alert('Por favor, selecione um entregador.');
                return;
            }
            updateStatus(pendingDeliveryOrderId, 'saiu_entrega', deliveryUserId);
            closeDeliveryModal();
        }

        async function switchView(viewId, btn) {
            // Update Sidebar
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            btn.classList.add('active');

            // Update Views
            document.querySelectorAll('.dashboard-view').forEach(view => view.classList.remove('active'));
            document.getElementById(`view-${viewId}`).classList.add('active');

            // Close sidebar on mobile after clicking
            if (window.innerWidth <= 900) {
                toggleSidebar();
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        async function updateStatus(id, status, delivery_user_id = null) {
            console.log(`[Dashboard] Tentando atualizar pedido #${id} para: ${status}`);

            try {
                const res = await fetch(`/api/admin/orders/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status, delivery_user_id })
                });

                if (res.ok) {
                    const updated = await res.json();
                    console.log('[Dashboard] Pedido atualizado com sucesso:', updated);
                    const idx = orders.findIndex(o => o.id === updated.id);
                    if (idx !== -1) {
                        orders[idx] = updated;
                        renderBoard();
                    }
                } else {
                    if (res.status === 401) {
                        showToast("Sess√£o expirada. Recarregue a p√°gina.", "error");
                        window.location.href = '/admin-login.html';
                        return;
                    }
                    const errorData = await res.json().catch(() => ({ error: 'Erro desconhecido no servidor' }));
                    console.error('[Dashboard] Erro na requisi√ß√£o:', errorData);
                    showToast(errorData.error || "Erro ao atualizar pedido.", "error");
                }
            } catch (err) {
                console.error('[Dashboard] Erro Cr√≠tico:', err);
                showToast("Erro de conex√£o com o servidor.", "error");
            }
        }

        socket.on('novo_pedido', (order) => {
            orders.unshift(order);
            renderBoard();
            orderSound.play().catch(() => { });
            notifyVoice("Ol√° Santa Ressaca, novo pedido chegou");
        });

        socket.on('pedido_atualizado', (order) => {
            const idx = orders.findIndex(o => o.id === order.id);
            if (idx !== -1) {
                orders[idx] = order;
                renderBoard();
            }
        });

        socket.on('pedidos_resetados', () => {
            orders = [];
            renderBoard();
            showToast("O hist√≥rico foi limpo pelo administrador.", "warning");
        });

        // WHATSAPP SOCKETS
        socket.on('whatsapp_qr', (qr) => {
            console.log('[Dashboard] QR Code recebido');
            const qrContainer = document.getElementById('qr-container');
            const canvas = document.getElementById('qr-canvas');
            const instruction = document.getElementById('wa-instruction');
            const badge = document.getElementById('wa-status-badge');
            const dot = document.getElementById('wa-status-dot');
            const actions = document.getElementById('wa-actions');

            qrContainer.style.display = 'block';
            actions.style.display = 'none';
            badge.innerText = 'AGUARDANDO LEITURA';
            badge.style.color = '#f39c12';
            dot.className = 'wa-status-circle disconnected';
            instruction.innerText = 'Escaneie o c√≥digo com seu WhatsApp para conectar.';

            QRCode.toCanvas(canvas, qr, { width: 250 }, (error) => {
                if (error) console.error(error);
            });
        });

        socket.on('whatsapp_status', (status) => {
            console.log('[Dashboard] Status WhatsApp:', status);
            const badge = document.getElementById('wa-status-badge');
            const instruction = document.getElementById('wa-instruction');
            const qrContainer = document.getElementById('qr-container');
            const dot = document.getElementById('wa-status-dot');
            const actions = document.getElementById('wa-actions');

            if (status === 'CONNECTED') {
                badge.innerText = 'CONECTADO';
                badge.style.color = '#2ecc71';
                dot.className = 'wa-status-circle connected';
                instruction.innerText = 'Seu WhatsApp est√° pronto para enviar notifica√ß√µes.';
                qrContainer.style.display = 'none';
                actions.style.display = 'flex';
            } else if (status === 'DISCONNECTED') {
                badge.innerText = 'DESCONECTADO';
                badge.style.color = '#e74c3c';
                dot.className = 'wa-status-circle disconnected';
                instruction.innerText = 'Aguardando o servidor gerar o QR Code...';
                qrContainer.style.display = 'none';
                actions.style.display = 'none';
            }
        });

        async function logoutWhatsApp() {
            if (!confirm("Deseja realmente desconectar o WhatsApp do site?")) return;
            try {
                const res = await fetch('/api/admin/whatsapp/logout', { method: 'POST' });
                if (res.ok) showToast("WhatsApp desconectado.", "success");
            } catch (e) { showToast("Erro ao desconectar.", "error"); }
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            const icons = { 'success': '‚úÖ', 'error': '‚ùå', 'warning': '‚ö†Ô∏è' };
            toast.className = `toast ${type}-premium`;
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || 'üîî'}</div>
                <div class="toast-content"><div class="toast-msg">${message}</div></div>
            `;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 4500);
        }

        // --- LOGICA CHAT INTEGRADO (MODERNA) ---
        let currentChatOrderId = null;
        let unreadCount = 0;

        function updateChatBadge() {
            const badge = document.getElementById('chat-badge');
            if (unreadCount > 0) {
                badge.innerText = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function toggleChat() {
            const panel = document.getElementById('chat-panel');
            if (panel.style.display === 'flex') {
                panel.style.display = 'none';
                unreadCount = 0;
                updateChatBadge();
            } else {
                panel.style.display = 'flex';
                updateOrderSelector();
            }
        }

        function openIntegratedChat(orderId) {
            const panel = document.getElementById('chat-panel');
            panel.style.display = 'flex';
            currentChatOrderId = orderId;
            updateOrderSelector().then(() => {
                document.getElementById('chat-order-select').value = orderId;
                loadSelectedOrderChat();
            });
        }

        async function updateOrderSelector() {
            const select = document.getElementById('chat-order-select');
            const currentVal = select.value;
            select.innerHTML = '<option value="">Selecione um pedido para conversar...</option>';

            const activeOrders = orders.filter(o => o.status !== 'entregue' && o.status !== 'cancelado');
            activeOrders.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.id;
                opt.innerText = `#${o.id} - ${o.customer_name}`;
                select.appendChild(opt);
            });

            if (currentVal) select.value = currentVal;
        }

        async function loadSelectedOrderChat() {
            const select = document.getElementById('chat-order-select');
            const orderId = select.value;
            currentChatOrderId = orderId;
            const container = document.getElementById('chat-messages-container');

            if (!orderId) {
                container.innerHTML = '<div style="text-align:center; color:#8696a0; margin-top:20px; font-size: 0.85rem;">Selecione um pedido para conversar.</div>';
                return;
            }

            try {
                const res = await fetch(`/api/admin/orders/${orderId}/messages`);
                const messages = await res.json();
                renderChatMessages(messages);

                // Limpa indicador de chat no card
                const indicator = document.getElementById('chat-indicator-' + orderId);
                if (indicator) indicator.style.display = 'none';
            } catch (e) {
                console.error('Erro ao carregar mensagens:', e);
            }
        }

        function renderChatMessages(messages) {
            const container = document.getElementById('chat-messages-container');
            container.innerHTML = '';

            if (messages.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#8696a0; margin-top:20px; font-size: 0.85rem;">Nenhuma mensagem ainda.</div>';
                return;
            }

            messages.forEach(m => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `chat-message ${m.sender_role}`;
                msgDiv.innerText = m.message;
                container.appendChild(msgDiv);
            });

            container.scrollTop = container.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message || !currentChatOrderId) return;

            try {
                const res = await fetch(`/api/admin/orders/${currentChatOrderId}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sender_role: 'admin', message })
                });

                if (res.ok) {
                    input.value = '';
                    loadSelectedOrderChat();
                }
            } catch (e) {
                console.error('Erro ao enviar mensagem:', e);
            }
        }

        async function resetOrders() {
            if (!confirm("‚ö†Ô∏è ATEN√á√ÉO: Isso apagar√° TODOS os pedidos e mensagens do banco de dados definitivamente. Continuar?")) return;
            try {
                const res = await fetch('/api/admin/reset-orders', { method: 'POST' });
                if (res.ok) {
                    showToast("Todo o hist√≥rico foi apagado.", "success");
                }
            } catch (e) { showToast("Erro ao resetar dados.", "error"); }
        }

        // Socket listener para chat
        socket.on('novo_chat_msg', (data) => {
            if (data.order_id == currentChatOrderId) {
                loadSelectedOrderChat();
            } else if (data.sender_role === 'customer') {
                unreadCount++;
                updateChatBadge();
                chatSound.play().catch(() => { });

                const indicator = document.getElementById('chat-indicator-' + data.order_id);
                if (indicator) indicator.style.display = 'block';
            }
        });

        // Atualizar seletor se novos pedidos chegarem
        socket.on('novo_pedido', () => {
            if (document.getElementById('chat-panel').style.display === 'flex') {
                updateOrderSelector();
            }
        });

        // ========================================
        // IMPORTA√á√ÉO EM MASSA DE PRODUTOS
        // ========================================
        let importSelectedFile = null;
        let importProducts = [];

        function openImportModal() {
            document.getElementById('importModal').style.display = 'flex';
            resetImportModal();
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            resetImportModal();
            fetchProducts(); // Refresh product list
        }

        function resetImportModal() {
            importSelectedFile = null;
            importProducts = [];
            document.getElementById('import-file-input').value = '';
            showImportStep('upload');
            document.getElementById('import-file-preview').style.display = 'none';
            document.getElementById('btn-analyze-import').disabled = true;
        }

        function showImportStep(step) {
            ['upload', 'loading', 'preview', 'success'].forEach(s => {
                document.getElementById('import-step-' + s).style.display = s === step ? '' : 'none';
            });
        }

        // Drag and Drop
        (() => {
            const dz = document.getElementById('import-dropzone');
            if (!dz) return;
            ['dragenter', 'dragover'].forEach(evt => {
                dz.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dz.classList.add('drag-over'); });
            });
            ['dragleave', 'drop'].forEach(evt => {
                dz.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dz.classList.remove('drag-over'); });
            });
            dz.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    setImportFile(files[0]);
                }
            });
        })();

        function handleImportFileSelect(event) {
            const file = event.target.files[0];
            if (file) setImportFile(file);
        }

        function setImportFile(file) {
            const allowed = ['image/jpeg', 'image/png', 'image/webp', 'text/plain'];
            const ext = file.name.toLowerCase();
            if (!allowed.includes(file.type) && !ext.endsWith('.txt') && !ext.endsWith('.jpg') && !ext.endsWith('.jpeg') && !ext.endsWith('.png') && !ext.endsWith('.webp')) {
                showToast('Formato n√£o suportado. Use JPG, PNG, WEBP ou TXT.', 'error');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                showToast('Arquivo muito grande. M√°ximo 10MB.', 'error');
                return;
            }

            importSelectedFile = file;
            const isImg = file.type.startsWith('image');
            document.getElementById('import-file-icon').textContent = isImg ? 'üñºÔ∏è' : 'üìÑ';
            document.getElementById('import-file-name').textContent = file.name;
            document.getElementById('import-file-size').textContent = (file.size / 1024).toFixed(1) + ' KB';
            document.getElementById('import-file-preview').style.display = 'block';
            document.getElementById('btn-analyze-import').disabled = false;
        }

        function clearImportFile() {
            importSelectedFile = null;
            document.getElementById('import-file-input').value = '';
            document.getElementById('import-file-preview').style.display = 'none';
            document.getElementById('btn-analyze-import').disabled = true;
        }

        async function analyzeImportFile() {
            if (!importSelectedFile) return;

            const isTxt = importSelectedFile.name.toLowerCase().endsWith('.txt') || importSelectedFile.type === 'text/plain';
            showImportStep('loading');
            document.getElementById('import-loading-detail').textContent = isTxt
                ? 'Lendo arquivo de texto...'
                : 'Enviando imagem para an√°lise com IA... Isso pode levar at√© 30s.';

            const formData = new FormData();
            formData.append('file', importSelectedFile);

            try {
                const res = await fetch('/api/admin/products/import-analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await res.json();

                if (!res.ok) {
                    showToast(data.error || 'Erro ao analisar arquivo.', 'error');
                    showImportStep('upload');
                    return;
                }

                importProducts = data.products || [];
                if (importProducts.length === 0) {
                    showToast('Nenhum produto encontrado no arquivo.', 'error');
                    showImportStep('upload');
                    return;
                }

                renderImportPreview();
                showImportStep('preview');
                showToast(`${importProducts.length} produto(s) encontrado(s)!`, 'success');
            } catch (e) {
                console.error('[Import] Erro:', e);
                showToast('Erro de conex√£o ao analisar arquivo.', 'error');
                showImportStep('upload');
            }
        }

        function renderImportPreview() {
            const list = document.getElementById('import-products-list');
            document.getElementById('import-count').textContent = importProducts.length;

            list.innerHTML = importProducts.map((p, i) => `
                <div class="import-row" data-index="${i}">
                    <div>
                        <label style="font-size: 0.65rem; color: #666; display: block; margin-bottom: 2px;">NOME</label>
                        <input type="text" value="${(p.name || '').replace(/"/g, '&quot;')}" onchange="importProducts[${i}].name = this.value">
                    </div>
                    <div>
                        <label style="font-size: 0.65rem; color: #666; display: block; margin-bottom: 2px;">CATEGORIA</label>
                        <select onchange="importProducts[${i}].category = this.value">
                            <option value="Bebidas" ${p.category === 'Bebidas' ? 'selected' : ''}>Bebidas</option>
                            <option value="Combos" ${p.category === 'Combos' ? 'selected' : ''}>Combos</option>
                            <option value="Conveni√™ncia" ${p.category === 'Conveni√™ncia' ? 'selected' : ''}>Conveni√™ncia</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.65rem; color: #666; display: block; margin-bottom: 2px;">PRE√áO</label>
                        <input type="number" step="0.01" value="${p.price || 0}" onchange="importProducts[${i}].price = parseFloat(this.value)" style="width: 80px;">
                    </div>
                    <button class="import-row-del" onclick="removeImportRow(${i})" title="Remover">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function removeImportRow(index) {
            importProducts.splice(index, 1);
            renderImportPreview();
        }

        function addImportRow() {
            importProducts.push({ name: '', price: 0, category: 'Bebidas', description: '', image_url: '', is_active: true });
            renderImportPreview();
            // Scroll to bottom
            const list = document.getElementById('import-products-list');
            list.scrollTop = list.scrollHeight;
        }

        function backToUpload() {
            showImportStep('upload');
        }

        async function confirmImport() {
            // Collect latest values from DOM
            const rows = document.querySelectorAll('.import-row');
            const products = [];
            rows.forEach((row, i) => {
                const inputs = row.querySelectorAll('input');
                const select = row.querySelector('select');
                const name = inputs[0]?.value?.trim();
                const price = parseFloat(inputs[1]?.value) || 0;
                const category = select?.value || 'Bebidas';
                if (name) {
                    products.push({
                        name,
                        price,
                        category,
                        description: importProducts[i]?.description || '',
                        image_url: '',
                        is_active: true
                    });
                }
            });

            if (products.length === 0) {
                showToast('Nenhum produto v√°lido para importar.', 'error');
                return;
            }

            const btn = document.getElementById('btn-confirm-import');
            btn.disabled = true;
            btn.textContent = 'IMPORTANDO...';

            try {
                const res = await fetch('/api/admin/products/bulk-create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ products })
                });

                const data = await res.json();

                if (res.ok) {
                    document.getElementById('import-success-msg').textContent = `${data.count} produto(s) adicionado(s) ao estoque com sucesso!`;
                    showImportStep('success');
                    fetchProducts();
                } else {
                    showToast(data.error || 'Erro ao importar produtos.', 'error');
                    btn.disabled = false;
                    btn.textContent = '‚úÖ CONFIRMAR E IMPORTAR';
                }
            } catch (e) {
                console.error('[Import] Erro:', e);
                showToast('Erro de conex√£o ao importar.', 'error');
                btn.disabled = false;
                btn.textContent = '‚úÖ CONFIRMAR E IMPORTAR';
            }
        }

        init();
    </script>
</body>

</html>